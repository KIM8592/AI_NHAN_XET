<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>AI Nh·∫≠n x√©t h·ªçc sinh</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;display:flex;justify-content:center}
.container{max-width:1500px;width:100%;margin:20px;background:#fff;padding:20px;border-radius:8px}
.main{display:grid;grid-template-columns:360px 1fr;gap:15px}
.author-in-panel {
    text-align: right;         
    font-size: 13px;           
    color: #2c7be5;            
    font-style: Bold;        
    margin-bottom: 6px;        
    border: 1px solid #2c7be5; 
    background-color: #d9edf7; 
    padding: 2px 6px;          
    border-radius: 4px;        
    overflow: hidden;          /* ·∫©n ch·ªØ tr√†n ra */
    white-space: nowrap;       /* kh√¥ng xu·ªëng d√≤ng */
    box-sizing: border-box;
}

.author-in-panel span {
    display: inline-block;
    padding-left: 100%;        /* b·∫Øt ƒë·∫ßu b√™n ph·∫£i ngo√†i khung */
    animation: marquee 60s linear infinite;
}

@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

.panel{background:#f1f3f4;padding:15px;border-radius:6px}
label{font-weight:bold;margin-top:10px;display:block}

input,select,textarea,button{
width:100%;padding:8px;margin-top:5px;font-size:14px
}

.api-key{border:2px solid #d9534f;background:#fff3cd;font-weight:bold}

button{
background:#007bff;color:#fff;border:none;border-radius:4px;
cursor:pointer;margin-top:10px
}
button:hover{background:#0056b3}

/* To√†n b·ªô CSS b·∫£ng hi·ªÉn th·ªã */
.table {
    height:70vh;
    overflow:auto;
    border:1px solid #ccc;
    background:#fff;
}

table {
    border-collapse:collapse;
    width:100%;
    font-size:13px;
    table-layout:fixed; /* quan tr·ªçng ƒë·ªÉ c·ªë ƒë·ªãnh chi·ªÅu r·ªông c·ªôt */
}

th, td {
    border:1px solid #ccc;
    padding:4px;
    vertical-align:top;
    word-wrap:break-word; /* xu·ªëng d√≤ng t·ª± ƒë·ªông */
}

th {
    background:#f2f2f2;
    position:sticky;
    top:0;
    z-index:1;
    font-size:12px;
    text-align:center;
}

td input, td textarea {
    width:100%;
    border:none;
    background:transparent;
    font-size:12px;
    line-height:1.2;
    padding:2px;
    min-height:24px;
    white-space:pre-wrap;
}

/* C·ªôt TT (th·ª© t·ª±) */
th:nth-child(1), td:nth-child(1) {
    width:30px;
    max-width:30px;
    text-align:center;
}

/* C·ªôt H·ªç v√† t√™n */
th:nth-child(2), td:nth-child(2) {
    width:150px;
    max-width:150px;
}

/* C·ªôt M·ª©c ƒë·∫°t */
th:nth-child(3), td:nth-child(3) {
    width:60px;
    max-width:60px;
    text-align:center;
}

/* C·ªôt Nh·∫≠n x√©t */
th:nth-child(4), td:nth-child(4) {
    width:300px;
    max-width:300px;
}

/* Progress */
.progress-wrap{
    margin-top:10px;
    background:#ddd;
    border-radius:6px;
    overflow:hidden;
}
.progress{
    height:22px;
    background:#28a745;
    color:#fff;
    text-align:center;
    font-weight:bold;
}

input{border:none;background:transparent}
textarea{
border:none;background:transparent;resize:vertical;
min-height:60px;width:100%;white-space:pre-wrap
}

.success{background:#d4edda;padding:8px;margin-top:10px}
.error{background:#f8d7da;padding:8px;margin-top:10px}
.info{background:#d1ecf1;padding:8px;margin-top:10px}

.progress-wrap{
margin-top:10px;background:#ddd;border-radius:6px;overflow:hidden
}
.progress{
height:22px;background:#28a745;color:#fff;
text-align:center;font-weight:bold
}

/* ü§ñ Tr·ª£ l√Ω ·∫£o */
#assistantBtn{
position:fixed;right:20px;bottom:20px;
width:55px;height:55px;border-radius:50%;
background:#007bff;color:#fff;
font-size:26px;border:none;cursor:pointer
}
#assistantBox{
position:fixed;right:20px;bottom:90px;
width:320px;max-height:420px;
background:#fff;border-radius:8px;
box-shadow:0 0 10px #999;
display:none;flex-direction:column
}
#assistantBox header{
background:#007bff;color:#fff;
padding:8px;border-radius:8px 8px 0 0
}
#assistantBox textarea{
border:1px solid #ccc;margin:8px
}
#assistantBox .log{
flex:1;overflow:auto;padding:8px;font-size:13px
}
</style>

</head>

<body onload="init()">
<div class="container">
<div class="author-in-panel">
  <span>‚ú®T√ÅC GI·∫¢: TR·∫¶N TR·ªåNG KIM‚ú®. ƒêI·ªÜN THO·∫†I: 0964567806. ƒê∆†N V·ªä: TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH, T·ªàNH AN GIANG ü§ñMONG NH·∫¨N ƒê∆Ø·ª¢C G√ìP √ù C·ª¶A QU√ù TH·∫¶Y/C√îü§ñ</span>
</div>

<h2>ü§ñ AI Nh·∫≠n x√©t & Chatbot</h2>
<div id="msg"></div>

<div class="main">
<div class="panel">

<label>ü§ñ Ch·ªçn AI</label>
<select id="ai">
<option value="gemini">Gemini</option>
<option value="roboki">Roboki</option>
</select>

<label>üîë API KEY</label>
<input id="apiKey" class="api-key" placeholder="Gemini ho·∫∑c Roboki API Key">

<label>üåê Roboki API URL</label>
<input id="robokiUrl" placeholder="https://api.roboki.ai/chat">

<button onclick="saveKey()">üíæ L∆∞u API Key</button>
<button onclick="downloadTemplate()">‚¨áÔ∏è T·∫¢I M·∫™U V·ªÄ M√ÅY</button>

<label>üìÅ T·∫£i Excel l√™n</label>
<input type="file" onchange="loadExcel(this)">

<label>üìù Prompt nh·∫≠n x√©t</label>
<textarea id="prompt">
Vi·∫øt ƒë√∫ng 1 c√¢u, b·∫Øt ƒë·∫ßu b·∫±ng Em, kh√¥ng qu√° 15 t·ª´, c√≥ 1 g·ª£i √Ω kh·∫Øc ph·ª•c.
</textarea>

<button onclick="start()">‚ú® B·∫Øt ƒë·∫ßu nh·∫≠n x√©t</button>

<div class="progress-wrap">
<div id="progressBox"></div>
</div>

<button onclick="exportExcel()" style="background:green">‚¨áÔ∏è Xu·∫•t Excel</button>
</div>

<div class="table" id="table"></div>
</div>
</div>

<!-- ü§ñ TR·ª¢ L√ù ·∫¢O -->
<button id="assistantBtn" onclick="toggleAssistant()">ü§ñ</button>
<div id="assistantBox">
<header>ü§ñ Tr·ª£ l√Ω gi√°o d·ª•c Ti·ªÉu h·ªçc</header>
<div class="log" id="assistantLog">
Xin ch√†o th·∫ßy/c√¥ üëã<br>
Em h·ªó tr·ª£ c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn:
<ul>
<li>Nh·∫≠n x√©t h·ªçc sinh ti·ªÉu h·ªçc</li>
<li>Nghi·ªáp v·ª• s∆∞ ph·∫°m</li>
</ul>
</div>
<textarea id="assistantInput" placeholder="Nh·∫≠p c√¢u h·ªèi..." onkeydown="checkEnter(event)"></textarea>
<button onclick="askAssistant()">H·ªèi</button>
</div>

<script>
const REVIEW="Nhan_xet";
let data=[],cols=[];
const MAP={T:"Ho√†n th√†nh t·ªët",H:"Ho√†n th√†nh",C:"Ch∆∞a ho√†n th√†nh"};

const msgBox=document.getElementById("msg");
const msg=(t,c)=>msgBox.innerHTML=`<div class="${c}">${t}</div>`;

function init(){
apiKey.value=localStorage.getItem("API_KEY")||"";
robokiUrl.value=localStorage.getItem("ROBOKI_URL")||"";
}

function saveKey(){
if(!apiKey.value) return msg("‚ùå Ch∆∞a nh·∫≠p API Key","error");
localStorage.setItem("API_KEY",apiKey.value);
localStorage.setItem("ROBOKI_URL",robokiUrl.value);
msg("üíæ ƒê√£ l∆∞u API Key","success");
}

function downloadTemplate(){
const ws=XLSX.utils.aoa_to_sheet([
["TT","Ho_va_Ten","Muc_Dat","Nhan_xet"],
[1,"Nguy·ªÖn VƒÉn A","T",""],
[2,"Tr·∫ßn Th·ªã B","H",""],
[3,"L√™ VƒÉn C","C",""]
]);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Mau");
XLSX.writeFile(wb,"Mau_nhan_xet_Tin_hoc.xlsx");
}

function loadExcel(input){
const f=input.files[0]; if(!f) return;
const r=new FileReader();
r.onload=e=>{
const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
const ws=wb.Sheets[wb.SheetNames[0]];
const arr=XLSX.utils.sheet_to_json(ws,{header:1});
cols=arr[0];
data=arr.slice(1).map(r=>{
let o={}; cols.forEach((c,i)=>o[c]=r[i]||""); return o;
});
render();
msg("‚úÖ ƒê√£ t·∫£i Excel","success");
};
r.readAsArrayBuffer(f);
}

function render(){
let h="<table><tr>";
cols.forEach(c=>h+=`<th>${c}</th>`); h+="</tr>";
data.forEach((r,i)=>{
h+="<tr>";
cols.forEach(c=>{
h+= c===REVIEW
? `<td><textarea onchange="data[${i}]['${c}']=this.value">${r[c]||""}</textarea></td>`
: `<td><input value="${r[c]||""}" onchange="data[${i}]['${c}']=this.value"></td>`;
});
h+="</tr>";
});
table.innerHTML=h;
}

async function callAI(level){
const key=localStorage.getItem("API_KEY");

const text = `
B·∫°n l√† AI vi·∫øt nh·∫≠n x√©t h·ªçc sinh.

M·ª©c ƒë·∫°t c·ªßa h·ªçc sinh: ${MAP[level] || level}.

H∆Ø·ªöNG D·∫™N C·ª¶A GI√ÅO VI√äN (B·∫ÆT BU·ªòC L√ÄM THEO):
${prompt.value}

‚ö†Ô∏è Ch·ªâ vi·∫øt ƒë√∫ng theo h∆∞·ªõng d·∫´n c·ªßa gi√°o vi√™n ·ªü tr√™n.
‚ö†Ô∏è Kh√¥ng t·ª± th√™m, kh√¥ng gi·∫£i th√≠ch, kh√¥ng suy di·ªÖn.
‚ö†Ô∏è Ch·ªâ tr·∫£ v·ªÅ n·ªôi dung nh·∫≠n x√©t.
`;

const res=await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({contents:[{parts:[{text}]}]})
});

const j=await res.json();
return j.candidates?.[0]?.content?.parts?.[0]?.text || "";
}

async function start(){
if(!localStorage.getItem("API_KEY"))
return msg("‚ùå Ch∆∞a l∆∞u API Key","error");

let list=data.filter(r=>r.Ho_va_Ten&&r.Muc_Dat&&!r[REVIEW]);
let done=0;

for(let r of list){
progressBox.innerHTML=
`ü§ñ ƒêang nh·∫≠n x√©t: <b>${r.Ho_va_Ten}</b>
<div class="progress" style="width:${done/list.length*100}%">
${done}/${list.length}
</div>`;

r[REVIEW]=await callAI(r.Muc_Dat);
done++;
render();
}

progressBox.innerHTML=`<div class="progress" style="width:100%">Ho√†n th√†nh</div>`;
msg("üéâ ƒê√£ nh·∫≠n x√©t xong","success");
}


function exportExcel(){
const ws=XLSX.utils.json_to_sheet(
data.map((r,i)=>({...r,TT:i+1}))
);
ws["!cols"]=[{wch:5},{wch:25},{wch:15},{wch:60}];
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Ket_qua");
XLSX.writeFile(wb,"Nhan_xet_AI.xlsx");
}

/* ü§ñ TR·ª¢ L√ù */
function toggleAssistant(){
assistantBox.style.display=
assistantBox.style.display==="flex"?"none":"flex";
}

async function askAssistant(){
const q=assistantInput.value.trim();
if(!q) return;
assistantLog.innerHTML+=`<b>Th·∫ßy/c√¥:</b> ${q}<br>`;
assistantInput.value="";

const text=`B·∫°n l√† tr·ª£ l√Ω gi√°o d·ª•c ti·ªÉu h·ªçc.
Ch·ªâ tr·∫£ l·ªùi c√°c n·ªôi dung li√™n quan ƒë·∫øn d·∫°y h·ªçc, s∆∞ ph·∫°m, ki·∫øn th·ª©c c√°c m√¥n h·ªçc ·ªü Ti·ªÉu h·ªçc.
C√¢u h·ªèi: ${q}`;

const res=await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${localStorage.getItem("API_KEY")}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({contents:[{parts:[{text}]}]})
});
const j=await res.json();
assistantLog.innerHTML+=
`<b>ü§ñ:</b> ${j.candidates?.[0]?.content?.parts?.[0]?.text||""}<br>`;
assistantLog.scrollTop=assistantLog.scrollHeight;
}
</script>
</body>
</html>
