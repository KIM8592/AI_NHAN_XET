<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons (UMD) - kept for icons not replaced by emoji -->
  <script src="https://unpkg.com/lucide@0.266.0/dist/lucide.iife.js"></script>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase compat (UMD) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- React / ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel in-browser to allow JSX in this single file -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html,body,#root { height: 100%; }
    textarea { resize: none; }
    /* spinner */
    .spin { animation: spin 1s linear infinite; display:inline-block; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="antialiased bg-[#F8FAFC]">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Helper to create small emoji icon React components
    function makeEmojiIcon(symbol) {
      return ({ size = 16, className = "" } = {}) => {
        const style = { fontSize: size, lineHeight: 1, display: 'inline-block' };
        return <span aria-hidden="true" className={className} style={style}>{symbol}</span>;
      };
    }

    // Emoji icon components requested
    const Plus = makeEmojiIcon('‚ûï'), Trash2 = makeEmojiIcon('üóëÔ∏è'), LayoutGrid = makeEmojiIcon('üß©'),
          Calendar = makeEmojiIcon('üìÖ'), BookOpen = makeEmojiIcon('üìñ'), UserPlus = makeEmojiIcon('üë§‚ûï'),
          Sparkles = makeEmojiIcon('‚ú®'), Loader2 = makeEmojiIcon('‚è≥'), Wand2 = makeEmojiIcon('ü™Ñ'),
          GraduationCap = makeEmojiIcon('üéì'), Edit2 = makeEmojiIcon('‚úèÔ∏è'), Eye = makeEmojiIcon('üëÅÔ∏è'),
          EyeOff = makeEmojiIcon('üôà'), Download = makeEmojiIcon('‚¨áÔ∏è'), ShieldAlert = makeEmojiIcon('üõ°Ô∏è'),
          CheckCircle2 = makeEmojiIcon('‚úÖ'), User = makeEmojiIcon('üë§'), Star = makeEmojiIcon('‚≠ê'),
          Settings = makeEmojiIcon('‚öôÔ∏è');

    // Firebase config (kept)
    const myFirebaseConfig = {
      apiKey: "AIzaSyCuomTR3xRgkk4YLCvc7bCKR2chx--AxvA",
      authDomain: "th-khanh-binh-manager.firebaseapp.com",
      projectId: "th-khanh-binh-manager",
      storageBucket: "th-khanh-binh-manager.firebasestorage.app",
      messagingSenderId: "772130590846",
      appId: "1:772130590846:web:108a05c64e2c5083ce882f"
    };
    const firebaseConfig = myFirebaseConfig;

    // Init firebase compat
    if (!window.firebase.apps.length) {
      window.firebase.initializeApp(firebaseConfig);
    }
    const auth = window.firebase.auth();
    const db = window.firebase.firestore();
    const appId = 'th-khanh-binh-manager';

    const AUTHOR_NAME = "Tr·∫ßn Tr·ªçng Kim";
    const AUTHOR_PHONE = "0964567806";

    const QUALITIES = [
      { id: 'patriotic', name: 'Y√™u n∆∞·ªõc', prompt: 'Y√™u thi√™n nhi√™n, di s·∫£n, c√≥ √Ω th·ª©c b·∫£o v·ªá m√¥i tr∆∞·ªùng, t·ª± h√†o v·ªÅ qu√™ h∆∞∆°ng.' },
      { id: 'kind', name: 'Nh√¢n √°i', prompt: 'Y√™u th∆∞∆°ng m·ªçi ng∆∞·ªùi, s·∫µn s√†ng gi√∫p ƒë·ª° b·∫°n b√®, t√¥n tr·ªçng s·ª± kh√°c bi·ªát.' },
      { id: 'diligent', name: 'ChƒÉm ch·ªâ', prompt: 'T·ª± gi√°c h·ªçc t·∫≠p, ham h·ªçc h·ªèi, y√™u lao ƒë·ªông, c√≥ tr√°ch nhi·ªám v·ªõi vi·ªác h·ªçc.' },
      { id: 'honest', name: 'Trung th·ª±c', prompt: 'Th·∫≠t th√† trong h·ªçc t·∫≠p v√† sinh ho·∫°t, d√°m nh·∫≠n l·ªói, kh√¥ng gian l·∫≠n.' },
      { id: 'responsible', name: 'Tr√°ch nhi·ªám', prompt: 'C√≥ √Ω th·ª©c v·ªõi b·∫£n th√¢n, gia ƒë√¨nh v√† t·∫≠p th·ªÉ, ho√†n th√†nh t·ªët nhi·ªám v·ª•.' }
    ];

    const GENERAL_COMPETENCIES = [
      { id: 'self_control', name: 'T·ª± ch·ªß v√† t·ª± h·ªçc', prompt: 'Bi·∫øt t·ª± th·ª±c hi·ªán nhi·ªám v·ª•, ƒëi·ªÅu ch·ªânh c·∫£m x√∫c, c√≥ th√≥i quen t·ª± h·ªçc.' },
      { id: 'communication', name: 'Giao ti·∫øp v√† h·ª£p t√°c', prompt: 'Bi·∫øt l·∫Øng nghe, tr√¨nh b√†y √Ω ki·∫øn, ph·ªëi h·ª£p t·ªët khi l√†m vi·ªác nh√≥m.' },
      { id: 'problem_solving', name: 'Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v√† s√°ng t·∫°o', prompt: 'Bi·∫øt ph√°t hi·ªán v·∫•n ƒë·ªÅ ƒë∆°n gi·∫£n, ƒë·ªÅ xu·∫•t c√°ch gi·∫£i quy·∫øt m·ªõi m·∫ª.' }
    ];

    const SPECIFIC_COMPETENCIES = [
      { id: 'lang', name: 'Ng√¥n ng·ªØ', prompt: 'ƒê·ªçc l∆∞u lo√°t, di·ªÖn c·∫£m. N√≥i m·∫°ch l·∫°c. Vi·∫øt ƒë√∫ng ch√≠nh t·∫£, s·∫°ch ƒë·∫πp.' },
      { id: 'math', name: 'T√≠nh to√°n', prompt: 'Th·ª±c hi·ªán t·ªët c√°c ph√©p t√≠nh. V·∫≠n d·ª•ng ki·∫øn th·ª©c v√†o th·ª±c t·∫ø ch√≠nh x√°c.' },
      { id: 'sci', name: 'Khoa h·ªçc', prompt: 'Quan s√°t t·ªët th·∫ø gi·ªõi t·ª± nhi√™n. C√≥ √Ω th·ª©c b·∫£o v·ªá s·ª©c kh·ªèe, m√¥i tr∆∞·ªùng.' },
      { id: 'tech', name: 'C√¥ng ngh·ªá', prompt: 'S·ª≠ d·ª•ng b·ªô ƒë·ªì d√πng h·ªçc t·∫≠p hi·ªáu qu·∫£. Bi·∫øt d√πng thi·∫øt b·ªã ƒë∆°n gi·∫£n.' },
      { id: 'it', name: 'Tin h·ªçc', prompt: 'S·ª≠ d·ª•ng thi·∫øt b·ªã s·ªë c∆° b·∫£n. Thu th·∫≠p th√¥ng tin qua h√¨nh ·∫£nh g·ª£i √Ω.' },
      { id: 'art', name: 'Th·∫©m mƒ©', prompt: 'C·∫£m nh·∫≠n v·∫ª ƒë·∫πp √¢m nh·∫°c, h·ªôi h·ªça. Di·ªÖn ƒë·∫°t c·∫£m x√∫c qua ngh·ªá thu·∫≠t.' },
      { id: 'phys', name: 'Th·ªÉ ch·∫•t', prompt: 'T·ª± gi√°c t·∫≠p luy·ªán. T√≠ch c·ª±c tham gia tr√≤ ch∆°i v·∫≠n ƒë·ªông.' }
    ];

    const SUBJECT_TO_COMPETENCY_MAP = {
      'Ti·∫øng Vi·ªát': 'lang', 'To√°n': 'math', 'Khoa h·ªçc': 'sci', 'T·ª± nhi√™n v√† X√£ h·ªôi': 'sci',
      'C√¥ng ngh·ªá': 'tech', 'Tin h·ªçc': 'it', 'Mƒ© thu·∫≠t': 'art', 'Gi√°o d·ª•c Th·ªÉ ch·∫•t': 'phys'
    };

    // small Zalo svg (kept)
    const ZaloIcon = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}>
        <path d="M22.507 11.23c-.156-.464-.34-.916-.548-1.353-.207-.436-.45-.858-.72-1.26a10.023 10.023 0 0 0-1.077-1.378 10.662 10.662 0 0 0-1.428-1.265 11.996 11.996 0 0 0-1.742-1.082A13.437 13.437 0 0 0 14.885 4.1a14.897 14.897 0 0 0-2.264-.474c-.38-.046-.763-.075-1.147-.087-.384-.012-.767-.008-1.15.012-.383.02-.764.055-1.145.105-.38.05-.758.115-1.134.195a14.864 14.864 0 0 0-2.22.65c-.358.13-.71.277-1.054.44a11.905 11.905 0 0 0-1.928 1.157 10.323 10.323 0 0 0-1.547 1.455c-.23.272-.44.558-.626.858a9.146 9.146 0 0 0-.825 2.022 8.79 8.79 0 0 0-.256 2.115c.01.353.04.706.087 1.055.048.35.114.697.198 1.04.084.343.187.68.307 1.01.12.33.256.654.407.97.15.316.315.626.494.927.18.3.37.593.578.877.207.284.426.56.654.825l-.578 2.316c-.052.207-.063.424-.032.636.03.21.096.413.195.6a1.442 1.442 0 0 0 .61.624c.24.13.51.196.78.196a1.517 1.517 0 0 0 .584-.117l3.522-1.507c.394.135.795.247 1.202.333.407.086.82.147 1.236.183.416.036.834.048 1.253.036.418-.012.836-.048 1.25-.108a14.892 14.892 0 0 0 2.417-.63 12.01 12.01 0 0 0 2.15-1.045 10.323 10.323 0 0 0 1.763-1.42 9.074 9.074 0 0 0 1.233-1.69 8.72 8.72 0 0 0 .864-2.128 9.052 9.052 0 0 0 .04-2.227z" />
      </svg>
    );

    const EditableCell = ({ value, onSave, placeholder, className }) => {
      const [localValue, setLocalValue] = useState(value || '');
      const textareaRef = useRef(null);
      const timeoutRef = useRef(null);

      const adjustHeight = () => {
        const textarea = textareaRef.current;
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
        }
      };

      useEffect(() => {
        setLocalValue(value || '');
        setTimeout(adjustHeight, 0);
      }, [value]);

      const handleChange = (e) => {
        const newVal = e.target.value;
        setLocalValue(newVal);
        adjustHeight();

        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => {
          onSave(newVal);
        }, 800);
      };

      return (
        <textarea
          ref={textareaRef}
          className={`${className} overflow-hidden whitespace-pre-wrap break-words`}
          rows={1}
          value={localValue}
          onChange={handleChange}
          placeholder={placeholder}
        />
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [years, setYears] = useState([]);
      const [classes, setClasses] = useState([]);
      const [months, setMonths] = useState([]);
      const [subjects, setSubjects] = useState([]);
      const [students, setStudents] = useState([]);
      const [studentData, setStudentData] = useState({});

      const [selectedYearId, setSelectedYearId] = useState('');
      const [selectedClassId, setSelectedClassId] = useState('');
      const [selectedMonthId, setSelectedMonthId] = useState('');
      const [selectedSubId, setSelectedSubId] = useState('');

      const [viewMode, setViewMode] = useState('subject');
      const [showLevel, setShowLevel] = useState(true);
      const [showNote, setShowNote] = useState(true);

      const [modalType, setModalType] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [editItem, setEditItem] = useState(null);
      const [inputValue, setInputValue] = useState('');
      const [bulkInput, setBulkInput] = useState('');
      const [aiPrompt, setAiPrompt] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [copySuccess, setCopySuccess] = useState(null);
      const [isAuthValid, setIsAuthValid] = useState(true);

      const [showApiKeyModal, setShowApiKeyModal] = useState(false);
      const [apiKeyInput, setApiKeyInput] = useState(localStorage.getItem('ai_api_key') || '');
      const [apiKeyMissingNote, setApiKeyMissingNote] = useState(false);

      // helper to get nested collection refs using compat API
      const col = (...segments) => {
        // segments is like ['artifacts', appId, 'public', 'data', 'years']
        let ref = db.collection(segments[0]);
        for (let i = 1; i < segments.length; i++) {
          if (i % 2 === 1) {
            // doc id
            ref = ref.doc(segments[i]);
          } else {
            // collection
            ref = ref.collection(segments[i]);
          }
        }
        return ref;
      };

      useEffect(() => {
        if (window.lucide && window.lucide.replace) window.lucide.replace();
      });

      useEffect(() => {
        const _v = (s) => btoa(unescape(encodeURIComponent(s)));
        if (_v(AUTHOR_NAME) !== "VHLhuqduIFRy4buNbmcgS2lt" || _v(AUTHOR_PHONE) !== "MDk2NDU2NzgwNg==") {
          setIsAuthValid(false);
        }
      }, []);

      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await auth.signInWithCustomToken(__initial_auth_token);
            } else { await auth.signInAnonymously(); }
          } catch (err) { try { await auth.signInAnonymously(); } catch(e){console.error(e);} }
        };
        initAuth();
        const unsubscribe = auth.onAuthStateChanged(setUser);
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user || !isAuthValid) return;
        const yearsRef = col('artifacts', appId, 'public', 'data', 'years');
        const classesRef = col('artifacts', appId, 'public', 'data', 'classes');
        const monthsRef = col('artifacts', appId, 'public', 'data', 'months');
        const subjectsRef = col('artifacts', appId, 'public', 'data', 'subjects');

        const unsubYears = yearsRef.onSnapshot(s => {
          const arr = []; s.forEach(d => arr.push({ id: d.id, ...d.data() }));
          setYears(arr.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0)));
        });
        const unsubCla = classesRef.onSnapshot(s => {
          const arr = []; s.forEach(d => arr.push({ id: d.id, ...d.data() }));
          setClasses(arr.sort((a,b) => a.name.localeCompare(b.name, 'vi', { numeric: true })));
        });
        const unsubMon = monthsRef.onSnapshot(s => {
          const arr = []; s.forEach(d => arr.push({ id: d.id, ...d.data() }));
          setMonths(arr.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0)));
        });
        const unsubSub = subjectsRef.onSnapshot(s => {
          const arr = []; s.forEach(d => arr.push({ id: d.id, ...d.data() }));
          setSubjects(arr.sort((a,b) => a.name.localeCompare(b.name, 'vi')));
        });

        return () => { try{unsubYears();unsubCla();unsubMon();unsubSub();}catch(e){} };
      }, [user, isAuthValid]);

      useEffect(() => {
        if (!user || !selectedClassId || !selectedYearId || !isAuthValid) { setStudents([]); return; }
        const studentsRef = col('artifacts', appId, 'public', 'data', 'years', selectedYearId, 'classes', selectedClassId, 'students');
        const unsub = studentsRef.onSnapshot(s => {
          const arr = []; s.forEach(d => arr.push({ id: d.id, ...d.data() }));
          setStudents(arr.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)));
        });
        return () => unsub();
      }, [user, selectedClassId, selectedYearId, isAuthValid]);

      useEffect(() => {
        if (!user || !selectedMonthId || !selectedClassId || !selectedYearId || !isAuthValid) { setStudentData({}); return; }
        if (viewMode === 'subject' && !selectedSubId) { setStudentData({}); return; }
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const entriesRef = col('artifacts', appId, 'public', 'data', 'comments', key, 'entries');
        const unsub = entriesRef.onSnapshot(s => {
          const data = {};
          s.forEach(d => data[d.id] = d.data());
          setStudentData(data);
        });
        return () => unsub();
      }, [user, selectedSubId, selectedMonthId, selectedClassId, selectedYearId, viewMode, isAuthValid]);

      const updateCell = async (studentId, field, value) => {
        if (!user || !isAuthValid) return;
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const docRef = col('artifacts', appId, 'public', 'data', 'comments', key, 'entries').doc(studentId);

        let finalValue = value;
        const currentData = studentData[studentId];
        if (currentData && currentData[field] === value) finalValue = "";

        try {
          await docRef.set({ [field]: finalValue }, { merge: true });
        } catch(e) { console.error(e); }

        if (viewMode === 'subject' && field === 'level') {
          const subjectName = subjects.find(s => s.id === selectedSubId)?.name;
          const targetCompId = SUBJECT_TO_COMPETENCY_MAP[subjectName];
          if (targetCompId) {
            const compLevelValue = (finalValue === 'H') ? 'ƒê' : finalValue;
            const compKey = `${selectedYearId}_specific_${selectedMonthId}_${selectedClassId}`;
            const compDocRef = col('artifacts', appId, 'public', 'data', 'comments', compKey, 'entries').doc(studentId);
            try { await compDocRef.set({ [`level_${targetCompId}`]: compLevelValue }, { merge: true }); } catch(e){ console.error(e); }
          }
        }
      };

      const runBulkAI = async () => {
        if (!isAuthValid || isGenerating) return;

        const apiKey = localStorage.getItem('ai_api_key') || '';
        if (!apiKey) {
          // show modal and a note to ask user to enter key or contact Th·∫ßy Kim
          setApiKeyMissingNote(true);
          setShowApiKeyModal(true);
          return;
        }

        // L·∫•y danh s√°ch nh·ªØng em c√≥ m·ª©c ƒë·∫°t nh∆∞ng ch∆∞a c√≥ nh·∫≠n x√©t
        const targets = students.filter(s => {
          const d = studentData[s.id] || {};
          if (viewMode === 'subject') return d.level && !d.comment;
          if (viewMode === 'competency' || viewMode === 'quality') {
            const comps = viewMode === 'competency' ? GENERAL_COMPETENCIES : QUALITIES;
            return comps.some(c => d[`level_${c.id}`]) && !d.comment;
          }
          if (viewMode === 'specific') return SPECIFIC_COMPETENCIES.some(c => d[`level_${c.id}`]) && !d.comment;
          return false;
        });

        if (!targets.length) return;
        setIsGenerating(true);

        const subName = viewMode === 'subject' ? subjects.find(s=>s.id===selectedSubId)?.name : '';

        // Gom h·ªçc sinh th√†nh nh√≥m 20 em ƒë·ªÉ t·ªëi ∆∞u h√≥a context window c·ªßa AI
        const chunkSize = 20;
        for (let i = 0; i < targets.length; i += chunkSize) {
          const chunk = targets.slice(i, i + chunkSize);

          // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·∫ßu v√†o cho AI theo d·∫°ng b·∫£ng
          const inputData = chunk.map(s => {
            const d = studentData[s.id] || {};
            let info = "";
            if (viewMode === 'subject') info = `M·ª©c: ${d.level}. Ghi ch√∫: ${d.note || 'Kh√¥ng'}`;
            else {
              const comps = viewMode === 'competency' ? GENERAL_COMPETENCIES : (viewMode === 'quality' ? QUALITIES : SPECIFIC_COMPETENCIES);
              info = comps.map(c => d[`level_${c.id}`] ? `${c.name}: ${d[`level_${c.id}`]}` : null).filter(Boolean).join(', ');
              if (d.note) info += `. Ghi ch√∫: ${d.note}`;
            }
            return { id: s.id, name: s.name, data: info };
          });

          const systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc Vi·ªát Nam. H√£y vi·∫øt nh·∫≠n x√©t h·ªçc sinh theo ƒë·ªãnh d·∫°ng JSON.
      QUY T·∫ÆC CHUNG:
      - Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát, g·∫ßn g≈©i, kh√≠ch l·ªá. 
      - C·∫•u tr√∫c: B·∫Øt ƒë·∫ßu b·∫±ng 'Em...'. D√†i kho·∫£ng 30-40 t·ª´.
      - KH√îNG d√πng t·ª´ 'Ho√†n th√†nh t·ªët' cho h·ªçc sinh ·ªü m·ª©c ƒê·∫°t (ƒê) ho·∫∑c Ho√†n th√†nh (H).
      - Tuy·ªát ƒë·ªëi kh√¥ng d√πng Th·∫ßy/c√¥.
      - KH√îNG l·∫∑p l·∫°i t√™n m√¥n h·ªçc ho·∫∑c t√™n nƒÉng l·ª±c.
      - D·ª±a v√†o 'data' ƒë·ªÉ vi·∫øt. M·ª©c T (T·ªët) th√¨ khen ng·ª£i. M·ª©c ƒê/H (ƒê·∫°t) th√¨ n√™u ∆∞u ƒëi·ªÉm v√† h∆∞·ªõng c·ªë g·∫Øng. M·ª©c C (Ch∆∞a ƒë·∫°t) th√¨ n√™u nh·∫π ∆∞u ƒëi·ªÉm, n√™u h·∫°n ch·∫ø m·ªôt c√°ch t·∫ø nh·ªã v√† bi·ªán ph√°p kh·∫Øc ph·ª•c.
      - Ph·∫£i tr·∫£ v·ªÅ duy nh·∫•t m·ªôt m·∫£ng JSON c√°c ƒë·ªëi t∆∞·ª£ng c√≥ d·∫°ng: {"id": "ID_HOC_SINH", "comment": "C√ÇU_NH·∫¨N_X√âT"}`;

          const userPrompt = `D·ªØ li·ªáu ƒë√°nh gi√° ${viewMode === 'subject' ? 'M√¥n ' + subName : viewMode}:
      ${JSON.stringify(inputData)}
      
      Y√™u c·∫ßu th√™m c·ªßa GV: ${aiPrompt}
      H√£y vi·∫øt nh·∫≠n x√©t cho t·ª´ng h·ªçc sinh trong danh s√°ch tr√™n theo ƒë√∫ng ƒë·ªãnh d·∫°ng JSON y√™u c·∫ßu.`;

          try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
              })
            });

            const result = await res.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (responseText) {
              const parsedResults = JSON.parse(responseText);
              // C·∫≠p nh·∫≠t t·ª´ng em v√†o Firestore
              for (const item of parsedResults) {
                if (item.id && item.comment) {
                  await updateCell(item.id, 'comment', item.comment.trim());
                }
              }
            } else {
              console.warn("AI tr·∫£ v·ªÅ kh√¥ng c√≥ responseText", result);
            }
          } catch (e) {
            console.error("L·ªói khi g·ªçi AI h√†ng lo·∫°t:", e);
          }
        }

        setIsGenerating(false);
      };

      const handleSendZalo = (studentId) => {
        if (!isAuthValid) return;
        const stu = students.find(s => s.id === studentId);
        const data = studentData[studentId];
        if (!stu || !data?.comment) return;
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c chung' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NƒÉng l·ª±c ƒë·∫∑c th√π'));
        const message = `‚ú® TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH ‚ú®\nüíå TH∆Ø KHEN G·ª¨I GIA ƒê√åNH EM: ${stu.name.toUpperCase()}\n---------------------------\nüåà L·ªõp: ${classes.find(c=>c.id===selectedClassId)?.name}\nüìò N·ªôi dung: ${subName} (${months.find(m=>m.id===selectedMonthId)?.name})\n\nüìù Nh·∫≠n x√©t:\n"${data.comment}"\n\n‚ù§Ô∏è Ch√∫c con lu√¥n chƒÉm ngoan!\n‚ù§Ô∏èTR·ª¢ L√ù TI·ªÇU H·ªåC‚ù§Ô∏è: https://roboki.vn/`;
        const el = document.createElement('textarea'); el.value = message; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        setCopySuccess(studentId); setTimeout(() => setCopySuccess(null), 2000); window.open('https://chat.zalo.me/', '_blank');
      };

      const exportExcel = () => {
        if (!students.length || !window.XLSX) return;
        const className = classes.find(c => c.id === selectedClassId)?.name || 'L·ªõp';
        const monthName = months.find(m => m.id === selectedMonthId)?.name || 'Th√°ng';
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NƒÉng l·ª±c ƒë·∫∑c th√π'));

        let worksheetData = [
          ["B·∫¢NG NH·∫¨N X√âT ƒê√ÅNH GI√Å H·ªåC SINH"],
          [`L·ªõp: ${className} - ${monthName}`],
          [`N·ªôi dung: ${subName}`],
          [""]
        ];

        const currentComponents = viewMode === 'competency' ? GENERAL_COMPETENCIES : (viewMode === 'quality' ? QUALITIES : (viewMode === 'specific' ? SPECIFIC_COMPETENCIES : []));

        if (currentComponents.length > 0) {
          const header = ["STT", "H·ªå V√Ä T√äN", ...currentComponents.map(c => c.name)];
          if (viewMode === 'subject') header.push("M·ª®C T·ªîNG");
          header.push("NH·∫¨N X√âT CHI TI·∫æT");
          worksheetData.push(header);

          students.forEach((s, i) => {
            const d = studentData[s.id] || {};
            const row = [
              i + 1,
              s.name.toUpperCase(),
              ...currentComponents.map(c => d[`level_${c.id}`] || "")
            ];
            if (viewMode === 'subject') row.push(d.level || "");
            row.push(d.comment || "");
            worksheetData.push(row);
          });
        } else {
          const header = ["STT", "H·ªå V√Ä T√äN", "M·ª®C ƒê·∫†T", "NH·∫¨N X√âT CHI TI·∫æT"];
          worksheetData.push(header);

          students.forEach((s, i) => {
            const d = studentData[s.id] || {};
            const row = [
              i + 1,
              s.name.toUpperCase(),
              d.level || "",
              d.comment || ""
            ];
            worksheetData.push(row);
          });
        }

        const wb = window.XLSX.utils.book_new();
        const ws = window.XLSX.utils.aoa_to_sheet(worksheetData);
        const cols = [{ wch: 5 }, { wch: 25 }];
        const comps = viewMode === 'competency' ? GENERAL_COMPETENCIES : (viewMode === 'quality' ? QUALITIES : (viewMode === 'specific' ? SPECIFIC_COMPETENCIES : []));
        comps.forEach(() => cols.push({ wch: 10 }));
        if (viewMode === 'subject') cols.push({ wch: 10 });
        cols.push({ wch: 80 });
        ws['!cols'] = cols;

        window.XLSX.utils.book_append_sheet(wb, ws, "NhanXet");
        window.XLSX.writeFile(wb, `NhanXet_${className}_${monthName}_${viewMode}.xlsx`);
      };

      const SectionBox = ({ label, items, selectedId, onSelect, type, icon: Icon }) => (
        <div className="bg-white p-4 rounded-xl border-2 border-slate-300 shadow-sm flex flex-col gap-2">
          <div className="flex items-center justify-between mb-1">
            <span className="text-[11px] font-black text-slate-600 uppercase flex items-center gap-1.5"><Icon size={12}/> {label}</span>
            <div className="flex gap-1">
              {selectedId && (
                <>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setEditItem(item); setInputValue(item.name); setModalType(type); }} className="p-1 text-blue-500 hover:bg-blue-50 rounded"><Edit2 size={12}/></button>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setConfirmDelete({ type, id: item.id, name: item.name }); }} className="p-1 hover:text-red-600"><Trash2 size={12}/></button>
                </>
              )}
              <button onClick={() => { setEditItem(null); setInputValue(''); setModalType(type); }} className="p-1 text-indigo-500"><Plus size={14}/></button>
            </div>
          </div>
          <select value={selectedId || ''} onChange={(e) => onSelect(e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-bold outline-none">
            <option value="">-- Ch·ªçn --</option>
            {items.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}
          </select>
        </div>
      );

      if (!isAuthValid) return <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white font-black">L·ªñI X√ÅC TH·ª∞C B·∫¢N QUY·ªÄN</div>;

      const currentComponents = viewMode === 'competency' ? GENERAL_COMPETENCIES : (viewMode === 'quality' ? QUALITIES : (viewMode === 'specific' ? SPECIFIC_COMPETENCIES : []));

      return (
        <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-12 font-sans text-left flex flex-col">
          <header className="bg-indigo-900 text-white p-6 shadow-xl border-b-4 border-indigo-700">
            <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center w-full gap-4">
              <div className="flex items-center gap-4">
                <div className="p-2 bg-white/20 rounded-xl"><GraduationCap size={32}/></div>
                <div className="flex flex-col">
                  <h1 className="text-xl font-black uppercase leading-none">ƒê√ÅNH GI√Å TH∆Ø·ªúNG XUY√äN</h1>
                  <span className="text-indigo-300 text-[11px] font-bold uppercase mt-1 italic">TI·ªÇU H·ªåC KH√ÅNH B√åNH - D·∫™N L·ªêI T∆Ø∆†NG LAI</span>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="flex bg-indigo-950/50 p-1 rounded-xl gap-1">
                   {[
                     {id: 'subject', label: 'M√¥n h·ªçc'},
                     {id: 'competency', label: 'NƒÉng l·ª±c chung'},
                     {id: 'quality', label: 'Ph·∫©m ch·∫•t'},
                     {id: 'specific', label: 'NL ƒê·∫∑c th√π'}
                   ].map(m => (
                     <button key={m.id} onClick={() => setViewMode(m.id)} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${viewMode === m.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-300 hover:text-white'}`}>
                       {m.label}
                     </button>
                   ))}
                </div>

                <div className="relative">
                  <button onClick={() => { setShowApiKeyModal(true); setApiKeyInput(localStorage.getItem('ai_api_key') || ''); setApiKeyMissingNote(false); }} className="px-3 py-2 bg-yellow-400 text-black font-bold rounded-lg shadow">
                    <Settings size={16}/> API Key
                  </button>
                </div>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <SectionBox label="NƒÉm h·ªçc" icon={Calendar} items={years} selectedId={selectedYearId} onSelect={setSelectedYearId} type="year" />
            <SectionBox label="L·ªõp h·ªçc" icon={LayoutGrid} items={classes} selectedId={selectedClassId} onSelect={setSelectedClassId} type="class" />
            <SectionBox label="Th√°ng" icon={Calendar} items={months} selectedId={selectedMonthId} onSelect={setSelectedMonthId} type="month" />
            {viewMode === 'subject' ? <SectionBox label="M√¥n h·ªçc" icon={BookOpen} items={subjects} selectedId={selectedSubId} onSelect={setSelectedSubId} type="subject" /> : <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200 shadow-sm flex items-center justify-center font-black text-indigo-700 text-[10px] uppercase gap-2">{viewMode === 'quality' ? <Star size={14}/> : <User size={14}/>} {viewMode === 'competency' ? 'NƒÉng l·ª±c chung' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NL ƒê·∫∑c th√π')}</div>}
          </div>

          <main className="max-w-7xl mx-auto px-4 md:px-6 flex-1">
            {selectedYearId && selectedClassId && selectedMonthId && (viewMode !== 'subject' || selectedSubId) ? (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl p-6 border-2 border-slate-300 shadow-sm flex flex-col gap-4">
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                    <div className="flex-1 w-full text-left">
                      <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">L∆∞u √Ω chung c·ªßa GV khi sinh nh·∫≠n x√©t h√†ng lo·∫°t</label>
                      <div className="relative">
                        <Sparkles size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400"/>
                        <input className="w-full bg-slate-50 border-2 border-slate-300 rounded-xl pl-12 pr-4 py-4 text-sm font-semibold outline-none" placeholder="VD: Nh·∫•n m·∫°nh t√≠nh t·ª± gi√°c, tinh th·∫ßn tr√°ch nhi·ªám..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)}/>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={runBulkAI} disabled={isGenerating || students.length === 0} className="px-8 py-4 bg-indigo-600 text-white rounded-xl font-black text-xs hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2 uppercase shadow-lg">
                        {isGenerating ? <Loader2 size={18} className="spin" /> : <Wand2 size={18} />} Nh·∫≠n x√©t c·∫£ l·ªõp
                      </button>
                      <button onClick={() => { setEditItem(null); setBulkInput(''); setModalType('student'); }} className="p-4 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-black"><UserPlus size={20}/></button>
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center justify-between pt-2 border-t border-slate-100 gap-3">
                    <div className="flex gap-2">
                      <button onClick={() => setShowLevel(!showLevel)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showLevel ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showLevel ? <EyeOff size={14}/> : <Eye size={14}/>} {showLevel ? '·∫®n m·ª©c ƒë·∫°t' : 'Hi·ªán m·ª©c ƒë·∫°t'}
                      </button>
                      <button onClick={() => setShowNote(!showNote)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showNote ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showNote ? <EyeOff size={14}/> : <Eye size={14}/>} {showNote ? '·∫®n ghi ch√∫' : 'Hi·ªán ghi ch√∫'}
                      </button>
                    </div>
                    <button onClick={exportExcel} disabled={students.length === 0} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-black uppercase hover:bg-emerald-700 shadow-md transition-all disabled:opacity-50">
                      <Download size={14}/> T·∫£i Excel
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-2xl border-2 border-slate-400 shadow-2xl overflow-hidden mb-8">
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse min-w-[1200px]">
                      <thead>
                        <tr className="bg-slate-200 border-b-2 border-slate-400">
                          <th className="p-4 text-center text-[10px] font-black uppercase w-12 border-r border-slate-400 sticky left-0 bg-slate-200 z-10">STT</th>
                          <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400 sticky left-12 bg-slate-200 z-10">H·ªçc sinh</th>
                          {showLevel && currentComponents.map(c => (
                            <th key={c.id} className="p-4 text-center text-[9px] font-black uppercase border-r border-slate-400 w-24">{c.name}</th>
                          ))}
                          {showLevel && viewMode === 'subject' && (
                            <th className="p-4 text-center text-[10px] font-black uppercase w-32 border-r border-slate-400">M·ª©c ƒê·∫°t</th>
                          )}
                          {showNote && <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400">Ghi ch√∫</th>}
                          <th className="p-4 text-center text-[10px] font-black uppercase min-w-[400px]">Nh·∫≠n x√©t chi ti·∫øt</th>
                          <th className="p-4 w-24 text-center text-[10px] font-black uppercase">G·ª≠i</th>
                          <th className="p-4 w-10"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y-2 divide-slate-300">
                        {students.map((stu, idx) => (
                          <tr key={stu.id} className="hover:bg-indigo-50/50 transition-all">
                            <td className="p-3 text-center text-xs font-bold text-slate-400 border-r border-slate-400 sticky left-0 bg-slate-50">{idx + 1}</td>
                            <td className="p-3 border-r border-slate-400 text-left sticky left-12 bg-white z-0"><span className="font-black text-slate-800 text-sm uppercase">{stu.name}</span></td>

                            {showLevel && currentComponents.map(c => (
                              <td key={c.id} className="p-1 border-r border-slate-400">
                                <div className="flex justify-center gap-0.5">
                                  {['T', 'ƒê', 'C'].map(lv => (
                                    <button key={lv} onClick={() => updateCell(stu.id, `level_${c.id}`, lv)} className={`w-6 h-6 rounded font-black text-[9px] transition-all ${studentData[stu.id]?.[`level_${c.id}`] === lv ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{lv}</button>
                                  ))}
                                </div>
                              </td>
                            ))}

                            {showLevel && viewMode === 'subject' && (
                              <td className="p-3 border-r border-slate-400">
                                <div className="flex justify-center gap-1">
                                  {['T', 'H', 'C'].map(lv => (
                                    <button key={lv} onClick={() => updateCell(stu.id, 'level', lv)} className={`w-8 h-8 rounded-lg font-black text-[10px] transition-all ${studentData[stu.id]?.level === lv ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{lv}</button>
                                  ))}
                                </div>
                              </td>
                            )}

                            {showNote && <td className="p-3 border-r border-slate-400"><EditableCell value={studentData[stu.id]?.note} onSave={(val) => updateCell(stu.id, 'note', val)} className="w-full bg-transparent text-xs font-bold text-indigo-700 outline-none text-left" /></td>}

                            <td className="p-3 text-left">
                              <EditableCell value={studentData[stu.id]?.comment} onSave={(val) => updateCell(stu.id, 'comment', val)} className="w-full bg-transparent text-sm font-medium border-none outline-none text-slate-700 text-left leading-relaxed" />
                            </td>

                            <td className="p-3 text-center border-l border-slate-200">
                              <button disabled={!studentData[stu.id]?.comment} onClick={() => handleSendZalo(stu.id)} className={`p-2.5 rounded-full mx-auto shadow-sm transition-all ${copySuccess === stu.id ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white disabled:opacity-30'}`}>
                                {copySuccess === stu.id ? <CheckCircle2 size={18} /> : <span style={{display:'inline-block', width:18, height:18}}><ZaloIcon size={18} /></span>}
                              </button>
                            </td>
                            <td className="p-3 text-center"><button onClick={() => setConfirmDelete({ type: 'student', id: stu.id, name: stu.name })} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ) : <div className="py-24 text-center bg-white rounded-3xl border-2 border-dashed border-slate-400 font-black text-slate-400 uppercase">Ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë√°nh gi√°</div>}
          </main>

          <footer className="max-w-7xl mx-auto w-full px-6 py-4 mt-8 bg-white/80 rounded-t-3xl border-t border-slate-200">
            <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                <div className="text-left italic">{AUTHOR_NAME} ‚Ä¢ {AUTHOR_PHONE}</div>
                <div className="text-right">H·ªá th·ªëng ƒê√°nh gi√° TH Kh√°nh B√¨nh ¬© {new Date().getFullYear()}</div>
            </div>
          </footer>

          {/* modal / confirm UI (kept) */}
          {modalType && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
              <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-left">
                <h3 className="text-xl font-black uppercase text-slate-800 mb-6">{editItem ? "S·ª≠a" : "Th√™m m·ªõi"}</h3>
                {modalType === 'student' ? <textarea autoFocus className="w-full h-64 p-4 bg-slate-50 border-2 border-slate-300 rounded-xl mb-6 text-left font-bold outline-none" placeholder="D√°n danh s√°ch h·ªçc sinh (m·ªói t√™n m·ªôt d√≤ng)..." value={bulkInput} onChange={e => setBulkInput(e.target.value)}/> : <input autoFocus className="w-full p-4 bg-slate-50 border-2 border-slate-300 rounded-xl font-bold mb-6 text-left outline-none" value={inputValue} onChange={e => setInputValue(e.target.value)}/>}
                <div className="flex gap-4"><button onClick={() => setModalType(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={async () => {
                  if (modalType === 'student') {
                    if (!bulkInput.trim()) return;
                    const names = bulkInput.split('\n').map(n => n.trim()).filter(n => n !== '');
                    const colRef = col('artifacts', appId, 'public', 'data', 'years', selectedYearId, 'classes', selectedClassId, 'students');
                    for (const name of names) {
                      try { await colRef.add({ name, createdAt: Date.now() }); } catch(e){ console.error(e); }
                    }
                    setBulkInput(''); setModalType(null);
                  } else {
                    if (!inputValue.trim()) return;
                    const colName = modalType === 'year' ? 'years' : modalType === 'class' ? 'classes' : modalType === 'month' ? 'months' : 'subjects';
                    const colRef = col('artifacts', appId, 'public', 'data', colName);
                    if (editItem) {
                      try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(colName).doc(editItem.id).update({ name: inputValue }); } catch(e){ console.error(e); }
                    } else {
                      try { await colRef.add({ name: inputValue, createdAt: Date.now() }); } catch(e){ console.error(e); }
                    }
                    setInputValue(''); setModalType(null);
                  }
                }} className="flex-[2] py-4 bg-indigo-600 text-white font-black rounded-xl uppercase text-[10px]">L∆∞u</button></div>
              </div>
            </div>
          )}

          {confirmDelete && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
              <div className="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl">
                <div className="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldAlert size={32} /></div>
                <h3 className="text-lg font-black mb-2 uppercase">X√°c nh·∫≠n x√≥a</h3>
                <p className="text-slate-500 text-sm mb-6">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <span className="text-red-600 font-bold">"{confirmDelete.name}"</span> kh√¥ng?</p>
                <div className="flex gap-4"><button onClick={() => setConfirmDelete(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={async () => {
                  try {
                    if (confirmDelete.type === 'student') {
                      await col('artifacts', appId, 'public', 'data', 'years', selectedYearId, 'classes', selectedClassId, 'students').doc(confirmDelete.id).delete();
                    } else {
                      const colName = confirmDelete.type === 'year' ? 'years' : confirmDelete.type === 'class' ? 'classes' : confirmDelete.type === 'month' ? 'months' : 'subjects';
                      await col('artifacts', appId, 'public', 'data', colName).doc(confirmDelete.id).delete();
                    }
                  } catch(e) { console.error(e); }
                  setConfirmDelete(null);
                }} className="flex-1 py-4 bg-red-600 text-white font-black rounded-xl uppercase text-[10px]">X√≥a</button></div>
              </div>
            </div>
          )}

          {showApiKeyModal && (
            <div className="fixed inset-0 z-60 flex items-center justify-center p-4 bg-slate-900/70">
              <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl">
                <h3 className="text-lg font-black mb-4">API Key Studio</h3>
                <p className="text-sm text-slate-600 mb-3">Nh·∫≠p API key ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng g·ªçi AI (Generative Language).</p>

                {apiKeyMissingNote && (
                  <div className="mb-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-slate-800">
                    B·∫°n ch∆∞a nh·∫≠p API key. Vui l√≤ng nh·∫≠p API key ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng "Nh·∫≠n x√©t c·∫£ l·ªõp".<br/>
                    N·∫øu c·∫ßn h·ªó tr·ª£, li√™n h·ªá Th·∫ßy Kim ‚Äî ƒêT: <span className="font-black">0964567806</span>
                  </div>
                )}

                <input value={apiKeyInput} onChange={e=>setApiKeyInput(e.target.value)} className="w-full p-3 border rounded-md mb-4" placeholder="Nh·∫≠p API key..."/>
                <div className="flex gap-3">
                  <button onClick={()=>{ setShowApiKeyModal(false); setApiKeyMissingNote(false); }} className="flex-1 py-2 bg-slate-100 font-black rounded">H·ªßy</button>
                  <button onClick={()=>{ localStorage.setItem('ai_api_key', apiKeyInput.trim()); setShowApiKeyModal(false); setApiKeyMissingNote(false); }} className="flex-1 py-2 bg-indigo-600 text-white font-black rounded">L∆∞u</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>