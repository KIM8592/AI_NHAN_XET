<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH - Standalone</title>

  <!-- Tailwind (CDN, for the original utility classes) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / ReactDOM UMD builds -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel to allow JSX in the browser (development only) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat builds so we can use similar APIs without bundling) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- xlsx library for Excel export (loaded again inside the app async too) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* Ensure monospace fallback for table-fixed elements used with tailwind classes */
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  </style>
</head>
<body class="bg-[#F8FAFC] font-sans">
  <div id="root"></div>

  <!-- Main app (JSX transpiled by Babel in the browser) -->
  <script type="text/babel">

    /*****************************************************************************
     * NOTE:
     * - This file converts the original React + modular-Firebase code into a
     *   standalone HTML page that runs without bundling.
     * - Kept original logic and updated pause between students to 15 seconds.
     *****************************************************************************/

    const { useState, useEffect, useRef } = React;

    // ---------- Minimal "icon" components (emoji-based placeholders) ----------
    const makeEmojiIcon = (emoji) => ({ size = 16, className = "" }) => (
      <span style={{ fontSize: size }} className={className} aria-hidden>{emoji}</span>
    );

    const Plus = makeEmojiIcon('‚ûï');
    const Trash2 = makeEmojiIcon('üóëÔ∏è');
    const LayoutGrid = makeEmojiIcon('üß©');
    const Calendar = makeEmojiIcon('üìÖ');
    const BookOpen = makeEmojiIcon('üìñ');
    const UserPlus = makeEmojiIcon('üë§‚ûï');
    const Sparkles = makeEmojiIcon('‚ú®');
    const X = makeEmojiIcon('‚ùå');
    const Loader2 = makeEmojiIcon('‚è≥');
    const Wand2 = makeEmojiIcon('ü™Ñ');
    const GraduationCap = makeEmojiIcon('üéì');
    const Edit2 = makeEmojiIcon('‚úèÔ∏è');
    const Eye = makeEmojiIcon('üëÅÔ∏è');
    const EyeOff = makeEmojiIcon('üôà');
    const Download = makeEmojiIcon('‚¨áÔ∏è');
    const ShieldAlert = makeEmojiIcon('üõ°Ô∏è');
    const CheckCircle2 = makeEmojiIcon('‚úÖ');
    const User = makeEmojiIcon('üë§');
    const Star = makeEmojiIcon('‚≠ê');

    // ---------- Zalo SVG icon kept inline ----------
    const ZaloIcon = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}>
        <path d="M22.507 11.23c-.156-.464-.34-.916-.548-1.353-.207-.436-.45-.858-.72-1.26a10.023 10.023 0 0 0-1.077-1.378 10.662 10.662 0 0 0-1.428-1.265 11.996 11.996 0 0 0-1.742-1.082A13.437 13.437 0 0 0 14.885 4.1a14.897 14.897 0 0 0-2.264-.474c-.38-.046-.763-.075-1.147-.087-.384-.012-.767-.008-1.15.012-.383.02-.764.055-1.145.105-.38.05-.758.115-1.134.195a14.864 14.864 0 0 0-2.22.65c-.358.13-.71.277-1.054.44a11.905 11.905 0 0 0-1.928 1.157 10.323 10.323 0 0 0-1.547 1.455c-.23.272-.44.558-.626.858a9.146 9.146 0 0 0-.825 2.022 8.79 8.79 0 0 0-.256 2.115c.01.353.04.706.087 1.055.048.35.114.697.198 1.04.084.343.187.68.307 1.01.12.33.256.654.407.97.15.316.315.626.494.927.18.3.37.593.578.877.207.284.426.56.654.825l-.578 2.316c-.052.207-.063.424-.032.636.03.21.096.413.195.6a1.442 1.442 0 0 0 .61.624c.24.13.51.196.78.196a1.517 1.517 0 0 0 .584-.117l3.522-1.507c.394.135.795.247 1.202.333.407.086.82.147 1.236.183.416.036.834.048 1.253.036.418-.012.836-.048 1.25-.108a14.892 14.892 0 0 0 2.417-.63 12.01 12.01 0 0 0 2.15-1.045 10.323 10.323 0 0 0 1.763-1.42 9.074 9.074 0 0 0 1.233-1.69 8.72 8.72 0 0 0 .864-2.128 9.052 9.052 0 0 0 .04-2.227z" />
      </svg>
    );

    // ---------- App config (kept as original) ----------
    const myFirebaseConfig = {
      apiKey: "AIzaSyCuomTR3xRgkk4YLCvc7bCKR2chx--AxvA",
      authDomain: "th-khanh-binh-manager.firebaseapp.com",
      projectId: "th-khanh-binh-manager",
      storageBucket: "th-khanh-binh-manager.firebasestorage.app",
      messagingSenderId: "772130590846",
      appId: "1:772130590846:web:108a05c64e2c5083ce882f"
    };

    const firebaseConfig = (myFirebaseConfig.apiKey !== "AIzaSy...")
      ? myFirebaseConfig
      : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig);

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = 'th-khanh-binh-manager';

    const AUTHOR_NAME = "Tr·∫ßn Tr·ªçng Kim";
    const AUTHOR_PHONE = "0964567806";

    const SPECIFIC_COMPETENCIES = [
      { id: 'lang', name: 'Ng√¥n ng·ªØ', prompt: 'ƒê·ªçc l∆∞u lo√°t, di·ªÖn c·∫£m, hi·ªÉu n·ªôi dung. N√≥i m·∫°ch l·∫°c, d√πng t·ª´ phong ph√∫. Vi·∫øt ƒë√∫ng ch√≠nh t·∫£, s·∫°ch ƒë·∫πp. T·ª± tin tr√¨nh b√†y.' },
      { id: 'math', name: 'T√≠nh to√°n', prompt: 'Th·ª±c hi·ªán t·ªët c√°c ph√©p t√≠nh c·ªông tr·ª´ nh√¢n chia. V·∫≠n d·ª•ng ki·∫øn th·ª©c v√†o th·ª±c t·∫ø. Nh·∫≠n bi·∫øt nhanh m√¥ h√¨nh to√°n h·ªçc. C·∫©n th·∫≠n, ch√≠nh x√°c.' },
      { id: 'sci', name: 'Khoa h·ªçc', prompt: 'Quan s√°t t·ªët th·∫ø gi·ªõi t·ª± nhi√™n. N√™u bi·ªán ph√°p b·∫£o v·ªá s·ª©c kh·ªèe, m√¥i tr∆∞·ªùng. Bi·∫øt ƒë·∫∑t c√¢u h·ªèi v·ªÅ s·ª± v·∫≠t hi·ªán t∆∞·ª£ng.' },
      { id: 'tech', name: 'C√¥ng ngh·ªá', prompt: 'S·ª≠ d·ª•ng b·ªô ƒë·ªì d√πng h·ªçc t·∫≠p hi·ªáu qu·∫£. Bi·∫øt d√πng thi·∫øt b·ªã ƒë∆°n gi·∫£n. ·ª®ng d·ª•ng ki·∫øn th·ª©c v√†o gi·∫£i quy·∫øt nhi·ªám v·ª•.' },
      { id: 'it', name: 'Tin h·ªçc', prompt: 'S·ª≠ d·ª•ng thi·∫øt b·ªã s·ªë c∆° b·∫£n. Thu th·∫≠p th√¥ng tin qua h√¨nh ·∫£nh/g·ª£i √Ω. C√≥ √Ω th·ª©c b·∫£o qu·∫£n thi·∫øt b·ªã.' },
      { id: 'art', name: 'Th·∫©m mƒ©', prompt: 'C·∫£m nh·∫≠n v·∫ª ƒë·∫πp √¢m nh·∫°c, h·ªôi h·ªça. Ch·ªçn m√†u s·∫Øc h√†i h√≤a. Di·ªÖn ƒë·∫°t c·∫£m x√∫c qua ngh·ªá thu·∫≠t.' },
      { id: 'phys', name: 'Th·ªÉ ch·∫•t', prompt: 'T·ª± gi√°c t·∫≠p luy·ªán. t√≠ch c·ª±c tham gia tr√≤ ch∆°i. Tham gia ho·∫°t ƒë·ªông ph√π h·ª£p b·∫£n th√¢n.' }
    ];

    const SUBJECT_TO_COMPETENCY_MAP = {
      'Ti·∫øng Vi·ªát': 'lang',
      'To√°n': 'math',
      'Khoa h·ªçc': 'sci',
      'C√¥ng ngh·ªá': 'tech',
      'Tin h·ªçc': 'it',
      'Mƒ© thu·∫≠t': 'art',
      'Gi√°o d·ª•c Th·ªÉ ch·∫•t': 'phys'
    };

    // ---------- EditableCell component (kept unchanged logic) ----------
    const EditableCell = ({ value, onSave, placeholder, className }) => {
      const [localValue, setLocalValue] = useState(value || '');
      const textareaRef = useRef(null);
      const timeoutRef = useRef(null);

      const adjustHeight = () => {
        const textarea = textareaRef.current;
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
        }
      };

      useEffect(() => {
        setLocalValue(value || '');
        setTimeout(adjustHeight, 0);
      }, [value]);

      const handleChange = (e) => {
        const newVal = e.target.value;
        setLocalValue(newVal);
        adjustHeight();

        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => {
          onSave(newVal);
        }, 800);
      };

      return (
        <textarea
          ref={textareaRef}
          className={`${className} overflow-hidden whitespace-pre-wrap break-words`}
          rows={1}
          value={localValue}
          onChange={handleChange}
          placeholder={placeholder}
        />
      );
    };

    // ---------- Helper: convenience functions to build compat paths ----------
    const rootArtifacts = () => db.collection('artifacts').doc(appId).collection('public').doc('data');
    const colYears = () => rootArtifacts().collection('years');
    const colClasses = () => rootArtifacts().collection('classes');
    const colMonths = () => rootArtifacts().collection('months');
    const colSubjects = () => rootArtifacts().collection('subjects');
    const colCommentsForKey = (key) => rootArtifacts().collection('comments').doc(key).collection('entries');
    const colStudents = (yearId, classId) => rootArtifacts().collection('years').doc(yearId).collection('classes').doc(classId).collection('students');

    // ---------- Small utility: sleep(ms) to pause between requests ----------
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // ---------- The main App ----------
    const App = () => {
      const [user, setUser] = useState(null);
      const [years, setYears] = useState([]);
      const [classes, setClasses] = useState([]);
      const [months, setMonths] = useState([]);
      const [subjects, setSubjects] = useState([]);
      const [students, setStudents] = useState([]);
      const [studentData, setStudentData] = useState({});

      const [selectedYearId, setSelectedYearId] = useState('');
      const [selectedClassId, setSelectedClassId] = useState('');
      const [selectedMonthId, setSelectedMonthId] = useState('');
      const [selectedSubId, setSelectedSubId] = useState('');

      const [viewMode, setViewMode] = useState('subject');
      const [showLevel, setShowLevel] = useState(true);
      const [showNote, setShowNote] = useState(true);

      const [modalType, setModalType] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [editItem, setEditItem] = useState(null);
      const [inputValue, setInputValue] = useState('');
      const [bulkInput, setBulkInput] = useState('');
      const [aiPrompt, setAiPrompt] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [copySuccess, setCopySuccess] = useState(null);
      const [isAuthValid, setIsAuthValid] = useState(true);

      // New states: API key for Google Studio AI, show/hide toggle, and api error message
      const [gApiKey, setGApiKey] = useState('');
      const [showApiKey, setShowApiKey] = useState(false);
      const [apiError, setApiError] = useState('');

      // load xlsx lib asynchronously (already loaded above but keep this to mirror original behavior)
      useEffect(() => {
        if (typeof window.XLSX === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.async = true;
          document.body.appendChild(script);
        }
      }, []);

      // local auth check (same as original)
      useEffect(() => {
        const _v = (s) => btoa(unescape(encodeURIComponent(s)));
        if (_v(AUTHOR_NAME) !== "VHLhuqduIFRy4buNbmcgS2lt" || _v(AUTHOR_PHONE) !== "MDk2NDU2NzgwNg==") {
          setIsAuthValid(false);
        }
      }, []);

      // Initialize auth (anonymous or custom token if provided)
      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await auth.signInWithCustomToken(__initial_auth_token);
            } else {
              await auth.signInAnonymously();
            }
          } catch (err) {
            await auth.signInAnonymously();
          }
        };
        initAuth();
        const unregister = auth.onAuthStateChanged((u) => setUser(u));
        return () => unregister && unregister();
      }, []);

      // load saved API key from localStorage on mount
      useEffect(() => {
        try {
          const saved = localStorage.getItem('gstudio_api_key');
          if (saved) setGApiKey(saved);
        } catch (e) {
          // ignore localStorage errors
        }
      }, []);

      // auto-save apiKey to localStorage when it changes (do not log the key)
      useEffect(() => {
        try {
          if (gApiKey) localStorage.setItem('gstudio_api_key', gApiKey);
          else localStorage.removeItem('gstudio_api_key');
        } catch (e) {
          // ignore localStorage errors
        }
      }, [gApiKey]);

      // Clear API error when user edits the key or prompt
      useEffect(() => { setApiError(''); }, [gApiKey, aiPrompt, selectedYearId, selectedClassId, selectedMonthId, selectedSubId, viewMode]);

      // Listen to master data lists
      useEffect(() => {
        if (!user || !isAuthValid) return;
        const unsubYears = colYears().onSnapshot(s => {
          setYears(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
        });
        const unsubCla = colClasses().onSnapshot(s => {
          setClasses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name, 'vi', { numeric: true })));
        });
        const unsubMon = colMonths().onSnapshot(s => {
          setMonths(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
        });
        const unsubSub = colSubjects().onSnapshot(s => {
          setSubjects(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name, 'vi')));
        });
        return () => { unsubYears && unsubYears(); unsubCla && unsubCla(); unsubMon && unsubMon(); unsubSub && unsubSub(); };
      }, [user, isAuthValid]);

      // Students list
      useEffect(() => {
        if (!user || !selectedClassId || !selectedYearId || !isAuthValid) { setStudents([]); return; }
        const q = colStudents(selectedYearId, selectedClassId);
        const unsub = q.onSnapshot((snap) => {
          setStudents(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)));
        });
        return () => unsub && unsub();
      }, [user, selectedClassId, selectedYearId, isAuthValid]);

      // Student data (comments / levels)
      useEffect(() => {
        if (!user || !selectedMonthId || !selectedClassId || !selectedYearId || !isAuthValid) { setStudentData({}); return; }
        if (viewMode === 'subject' && !selectedSubId) { setStudentData({}); return; }
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const q = colCommentsForKey(key);
        const unsub = q.onSnapshot((snap) => {
          const data = {};
          snap.forEach(doc => { data[doc.id] = doc.data(); });
          setStudentData(data);
        });
        return () => unsub && unsub();
      }, [user, selectedSubId, selectedMonthId, selectedClassId, selectedYearId, viewMode, isAuthValid]);

      // Update a single cell (set / toggle levels). Uses compat APIs.
      const updateCell = async (studentId, field, value) => {
        if (!user || !isAuthValid) return;
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const docRef = colCommentsForKey(key).doc(studentId);

        let finalValue = value;
        if (field.startsWith('level')) {
          const currentData = studentData[studentId];
          if (currentData && currentData[field] === value) {
            finalValue = "";
          }
        }

        await docRef.set({ [field]: finalValue }, { merge: true });

        if (viewMode === 'subject' && field === 'level') {
          const subjectName = subjects.find(s => s.id === selectedSubId)?.name;
          const targetCompId = SUBJECT_TO_COMPETENCY_MAP[subjectName];
          if (targetCompId) {
            const compLevelValue = (finalValue === 'H') ? 'ƒê' : finalValue;
            const compKey = `${selectedYearId}_specific_${selectedMonthId}_${selectedClassId}`;
            const compDocRef = colCommentsForKey(compKey).doc(studentId);
            await compDocRef.set({ [`level_${targetCompId}`]: compLevelValue }, { merge: true });
          }
        }
      };

      // Helper: validate API key by making a small test call; return text on success or throw
      const validateApiKey = async (apiKey) => {
        const systemInstruction = "Test validity: tr·∫£ v·ªÅ m·ªôt c√¢u ng·∫Øn 'OK' n·∫øu key h·ª£p l·ªá.";
        const userPrompt = "KI·ªÇM TRA KEY";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] },
          }),
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => '');
          throw new Error(`HTTP ${resp.status} ${resp.statusText}${txt ? `: ${txt}` : ''}`);
        }

        const result = await resp.json().catch(() => null);
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.');
        return text;
      };

      // Run AI: now uses gApiKey state, validates key, and pauses 15s between students
      const runAI = async () => {
        if (!isAuthValid) return;
        setApiError('');
        const targets = students.filter(s => {
          const d = studentData[s.id] || {};
          if (viewMode === 'specific') return SPECIFIC_COMPETENCIES.some(c => d[`level_${c.id}`]) && !d.comment;
          return d.level && !d.comment;
        });

        if (!targets.length) return;

        if (!gApiKey || !gApiKey.trim()) {
          setApiError('Vui l√≤ng nh·∫≠p M√£ kh√≥a - Li√™n h·ªá th·∫ßy Kim. ƒêT: 0964567806.');
          return;
        }

        setIsGenerating(true);

        // 1) Validate key with a lightweight test call before writing anything
        try {
          await validateApiKey(gApiKey.trim());
        } catch (e) {
          // Don't write anything; show error
          setApiError(`L·ªói API / API key kh√¥ng h·ª£p l·ªá: ${e.message || 'Kh√¥ng r√µ l·ªói'}`);
          setIsGenerating(false);
          return;
        }

        // 2) If validation ok, proceed to generate for each student and write results only when a valid text is returned.
        const urlBase = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${gApiKey.trim()}`;

        for (const stu of targets) {
          const data = studentData[stu.id] || {};
          let systemPrompt = "";
          let contextInfo = "";

          if (viewMode === 'subject') {
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t M√¥n h·ªçc. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i 20 t·ª´. 
            - M·ª©c T (T·ªët): Khen ng·ª£i th√†nh t√≠ch.
            - M·ª©c H (Ho√†n th√†nh): Khen nh·∫π, n√™u h∆∞·ªõng ph√°t huy. 
            - M·ª©c C (Ch∆∞a ho√†n th√†nh): Khen kh√≠ch l·ªá, n√™u h·∫°n ch·∫ø c·ª• th·ªÉ v√† h∆∞·ªõng kh·∫Øc ph·ª•c.
            - Kh√¥ng d√πng t·ª´ ho√†n th√†nh t·ªët ƒë·ªëi v·ªõi M·ª©c H (ho√†n th√†nh).`;
            contextInfo = `M√¥n: ${subjects.find(s=>s.id===selectedSubId)?.name}. M·ª©c: ${data.level}.`;
          } else if (viewMode === 'competency' || viewMode === 'quality') {
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t ${viewMode === 'competency' ? 'NƒÉng l·ª±c' : 'Ph·∫©m ch·∫•t'}. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i kho·∫£ng 30 t·ª´.
            - M·ª©c T (T·ªët): Khen ng·ª£i.
            - M·ª©c ƒê (ƒê·∫°t): Khen nh·∫π, h∆∞·ªõng ph√°t huy.
            - M·ª©c C (C·∫ßn c·ªë g·∫Øng): Khen kh√≠ch l·ªá, n√™u h·∫°n ch·∫ø v√† h∆∞·ªõng kh·∫Øc ph·ª•c.`;
            contextInfo = `M·ª©c: ${data.level}.`;
          } else if (viewMode === 'specific') {
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t NƒÉng l·ª±c ƒë·∫∑c th√π t·ªïng h·ª£p. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i kho·∫£ng 35-40 t·ª´. 
            D·ª±a v√†o m·ª©c ƒë·ªô T/ƒê/C c·ªßa c√°c ph√¢n m√¥n ƒë·ªÉ vi·∫øt c√¢u nh·∫≠n x√©t M·ªöI.
            KH√îNG li·ªát k√™ t√™n nƒÉng l·ª±c. 
            - N·∫øu c√≥ T: Khen s·ª± n·ªïi tr·ªôi ·ªü c√°c lƒ©nh v·ª±c ƒë√≥. 
            - N·∫øu c√≥ ƒê: Ghi nh·∫≠n s·ª± n·ªó l·ª±c, khuy·∫øn kh√≠ch ph√°t huy th√™m.
            - N·∫øu c√≥ C: Khen kh√≠ch l·ªá v√† ch·ªâ r√µ c·∫ßn r√®n luy·ªán th√™m lƒ©nh v·ª±c n√†o ƒë·ªÉ kh·∫Øc ph·ª•c.
            - B·∫Øt bu·ªôc kh√¥ng l·∫∑p l·∫°i t√™n c√°c nƒÉng l·ª±c.
            - B·∫Øt bu·ªôc d√πng t·ª´ li√™n quan ƒë·∫øn ti·ªÉu h·ªçc, kh√¥ng d√πng t·ª´ cao si√™u.
            - B·∫Øt bu·ªôc ghi n·ªôi dung vi·ªác l√†m c·ª• th·ªÉ c·ªßa h·ªçc sinh qua c√°c nƒÉng l·ª±c.`;

            const details = SPECIFIC_COMPETENCIES.map(c => {
              const lv = data[`level_${c.id}`];
              return lv ? `${c.name} (${lv}): ${c.prompt}` : null;
            }).filter(Boolean).join('. ');
            contextInfo = `D·ªØ li·ªáu ph√¢n m√¥n: ${details}`;
          }

          const userPrompt = `${contextInfo}. L∆∞u √Ω: ${aiPrompt}. Ghi ch√∫ ri√™ng: ${data.note || 'Kh√¥ng'}.`;

          try {
            const res = await fetch(urlBase, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
              })
            });

            if (!res.ok) {
              const txt = await res.text().catch(() => '');
              throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? `: ${txt}` : ''}`);
            }

            const result = await res.json().catch(() => null);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()?.replace(/[*\-#"']/g, '');

            if (!text) {
              throw new Error('API tr·∫£ v·ªÅ k·∫øt qu·∫£ r·ªóng ho·∫∑c kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.');
            }

            // Only write after successful generation
            await updateCell(stu.id, 'comment', text);

            // Pause 15 seconds to reduce token usage rate / API pressure
            await sleep(15000);

          } catch (e) {
            // On failure, stop processing further students and show error
            setApiError(`L·ªói khi g·ªçi API cho h·ªçc sinh ${stu.name}: ${e.message || 'Kh√¥ng r√µ l·ªói'}`);
            console.error(e && e.message ? e.message : e);
            break;
          }
        }

        setIsGenerating(false);
      };

      // Copy & open Zalo chat (identical behavior)
      const handleSendZalo = (studentId) => {
        if (!isAuthValid) return;
        const stu = students.find(s => s.id === studentId);
        const data = studentData[studentId] || {};
        if (!stu || !data?.comment) return;
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NƒÉng l·ª±c ƒë·∫∑c th√π'));
        const message = `‚ú® TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH ‚ú®\nüíå TH∆Ø KHEN G·ª¨I GIA ƒê√åNH EM: ${stu.name.toUpperCase()}\n---------------------------\nüåà L·ªõp: ${classes.find(c=>c.id===selectedClassId)?.name}\nüìò N·ªôi dung: ${subName} (${months.find(m=>m.id===selectedMonthId)?.name})\n\nüìù Nh·∫≠n x√©t:\n"${data.comment}"\n\n‚ù§Ô∏è Ch√∫c con lu√¥n chƒÉm ngoan!`;
        const el = document.createElement('textarea'); el.value = message; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        setCopySuccess(studentId); setTimeout(() => setCopySuccess(null), 2000); window.open('https://chat.zalo.me/', '_blank');
      };

      // Export to Excel using XLSX from CDN (keeps original format)
      const exportExcel = () => {
        if (!students.length || !window.XLSX) return;
        const className = classes.find(c => c.id === selectedClassId)?.name || 'L·ªõp';
        const monthName = months.find(m => m.id === selectedMonthId)?.name || 'Th√°ng';
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NƒÉng l·ª±c ƒë·∫∑c th√π'));

        let worksheetData = [
          ["B·∫¢NG NH·∫¨N X√âT ƒê√ÅNH GI√Å H·ªåC SINH"],
          [`L·ªõp: ${className} - ${monthName}`],
          [`N·ªôi dung: ${subName}`],
          [""]
        ];

        if (viewMode === 'specific') {
          const header = ["STT", "H·ªå V√Ä T√äN", ...SPECIFIC_COMPETENCIES.map(c => c.name), "NH·∫¨N X√âT CHI TI·∫æT"];
          worksheetData.push(header);

          students.forEach((s, i) => {
            const d = studentData[s.id] || {};
            const row = [
              i + 1,
              s.name.toUpperCase(),
              ...SPECIFIC_COMPETENCIES.map(c => d[`level_${c.id}`] || ""),
              d.comment || ""
            ];
            worksheetData.push(row);
          });
        } else {
          const header = ["STT", "H·ªå V√Ä T√äN", "M·ª®C ƒê·∫†T", "NH·∫¨N X√âT CHI TI·∫æT"];
          worksheetData.push(header);

          students.forEach((s, i) => {
            const d = studentData[s.id] || {};
            const row = [
              i + 1,
              s.name.toUpperCase(),
              d.level || "",
              d.comment || ""
            ];
            worksheetData.push(row);
          });
        }

        const wb = window.XLSX.utils.book_new();
        const ws = window.XLSX.utils.aoa_to_sheet(worksheetData);

        const cols = [{ wch: 5 }, { wch: 25 }];
        if (viewMode === 'specific') {
          SPECIFIC_COMPETENCIES.forEach(() => cols.push({ wch: 10 }));
          cols.push({ wch: 80 });
        } else {
          cols.push({ wch: 10 }, { wch: 80 });
        }
        ws['!cols'] = cols;

        window.XLSX.utils.book_append_sheet(wb, ws, "NhanXet");
        window.XLSX.writeFile(wb, `NhanXet_${className}_${monthName}.xlsx`);
      };

      // SectionBox subcomponent (keeps layout & behavior)
      const SectionBox = ({ label, items, selectedId, onSelect, type, icon: Icon }) => (
        <div className="bg-white p-4 rounded-xl border-2 border-slate-300 shadow-sm flex flex-col gap-2">
          <div className="flex items-center justify-between mb-1">
            <span className="text-[11px] font-black text-slate-600 uppercase flex items-center gap-1.5"><Icon size={12}/> {label}</span>
            <div className="flex gap-1">
              {selectedId && (
                <>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setEditItem(item); setInputValue(item.name); setModalType(type); }} className="p-1 text-blue-500 hover:bg-blue-50 rounded"><Edit2 size={12}/></button>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setConfirmDelete({ type, id: item.id, name: item.name }); }} className="p-1 hover:text-red-600"><Trash2 size={12}/></button>
                </>
              )}
              <button onClick={() => { setEditItem(null); setInputValue(''); setModalType(type); }} className="p-1 text-indigo-500"><Plus size={14}/></button>
            </div>
          </div>
          <select value={selectedId || ''} onChange={(e) => onSelect(e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-bold outline-none">
            <option value="">-- Ch·ªçn --</option>
            {items.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}
          </select>
        </div>
      );

      if (!isAuthValid) return <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white font-black">L·ªñI X√ÅC TH·ª∞C B·∫¢N QUY·ªÄN</div>;

      return (
        <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-12 font-sans text-left flex flex-col">
          <header className="bg-indigo-900 text-white p-6 shadow-xl border-b-4 border-indigo-700">
            <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center w-full gap-4">
              <div className="flex items-center gap-4">
                <div className="p-2 bg-white/20 rounded-xl"><GraduationCap size={32}/></div>
                <div className="flex flex-col">
                  <h1 className="text-xl font-black uppercase leading-none">ƒê√ÅNH GI√Å TH∆Ø·ªúNG XUY√äN</h1>
                  <span className="text-indigo-300 text-[11px] font-bold uppercase mt-1 italic">TI·ªÇU H·ªåC KH√ÅNH B√åNH - D·∫™N L·ªêI T∆Ø∆†NG LAI</span>
                </div>
              </div>
              <div className="flex bg-indigo-950/50 p-1 rounded-xl gap-1">
                 {['subject', 'competency', 'quality', 'specific'].map(m => (
                   <button key={m} onClick={() => setViewMode(m)} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${viewMode === m ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-300 hover:text-white'}`}>
                     {m === 'specific' ? 'NL ƒê·∫∑c th√π' : (m === 'subject' ? 'M√¥n h·ªçc' : (m === 'competency' ? 'NƒÉng l·ª±c' : 'Ph·∫©m ch·∫•t'))}
                   </button>
                 ))}
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <SectionBox label="NƒÉm h·ªçc" icon={Calendar} items={years} selectedId={selectedYearId} onSelect={setSelectedYearId} type="year" />
            <SectionBox label="L·ªõp h·ªçc" icon={LayoutGrid} items={classes} selectedId={selectedClassId} onSelect={setSelectedClassId} type="class" />
            <SectionBox label="Th√°ng" icon={Calendar} items={months} selectedId={selectedMonthId} onSelect={setSelectedMonthId} type="month" />
            {viewMode === 'subject' ? <SectionBox label="M√¥n h·ªçc" icon={BookOpen} items={subjects} selectedId={selectedSubId} onSelect={setSelectedSubId} type="subject" /> : <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200 shadow-sm flex items-center justify-center font-black text-indigo-700 text-[10px] uppercase gap-2">{viewMode === 'specific' ? <Star size={14}/> : <User size={14}/>} {viewMode.toUpperCase()}</div>}
          </div>

          <main className="max-w-7xl mx-auto px-4 md:px-6 flex-1">
            {selectedYearId && selectedClassId && selectedMonthId && (viewMode !== 'subject' || selectedSubId) ? (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl p-6 border-2 border-slate-300 shadow-sm flex flex-col gap-4">
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                    <div className="flex-1 w-full text-left">
                      <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">L∆∞u √Ω chung c·ªßa GV (AI  nghe theo)</label>
                      <div className="relative">
                        <Sparkles size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400"/>
                        <input className="w-full bg-slate-50 border-2 border-slate-300 rounded-xl pl-12 pr-4 py-4 text-sm font-semibold outline-none" placeholder="VD: Nh·∫•n m·∫°nh t√≠nh t·ª± gi√°c..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)}/>
                      </div>
                    </div>

                    <div className="flex flex-col gap-2">
                      <div className="flex items-center gap-2">
                        <button onClick={runAI} disabled={isGenerating || students.length === 0} className="px-8 py-4 bg-indigo-600 text-white rounded-xl font-black text-xs hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2 uppercase shadow-lg">
                          {isGenerating ? <Loader2 className="animate-spin" size={18}/> : <Wand2 size={18}/>} Nh·∫≠n x√©t AI
                        </button>
                        <button onClick={() => { setEditItem(null); setBulkInput(''); setModalType('student'); }} className="p-4 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-black"><UserPlus size={20}/></button>
                      </div>

                      {/* New API key input */}
                      <div className="w-full">
                        <label className="text-[10px] font-black text-slate-500 uppercase mb-1 block">M√£ kh√≥a (Li√™n h·ªá: 0964567806)</label>
                        <div className="flex items-center gap-2">
                          <input
                            type={showApiKey ? 'text' : 'password'}
                            value={gApiKey}
                            onChange={e => setGApiKey(e.target.value)}
                            placeholder="D√ÅN M√É KH√ìA T·∫†I ƒê√ÇY"
                            className="w-full p-3 bg-slate-50 border border-slate-300 rounded-xl text-sm outline-none"
                          />
                          <button onClick={() => setShowApiKey(!showApiKey)} title={showApiKey ? '·∫®n key' : 'Hi·ªán key'} className="p-2 bg-white border rounded-lg shadow-sm">
                            {showApiKey ? <EyeOff size={16}/> : <Eye size={16}/>}
                          </button>
                        </div>
                        <p className="text-[11px] text-slate-400 mt-1">Ch√∫ √Ω kh√¥ng chia s·∫ª kh√≥a cho ng∆∞·ªùi kh√°c.</p>

                        {/* API error banner */}
                        {apiError && (
                          <div className="mt-3 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
                            <strong className="font-black uppercase text-xs">L·ªói API:</strong> <span className="ml-2">{apiError}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center justify-between pt-2 border-t border-slate-100 gap-3">
                    <div className="flex gap-2">
                      <button onClick={() => setShowLevel(!showLevel)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showLevel ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showLevel ? <EyeOff size={14}/> : <Eye size={14}/>} {showLevel ? '·∫®n m·ª©c ƒë·∫°t' : 'Hi·ªán m·ª©c ƒë·∫°t'}
                      </button>
                      <button onClick={() => setShowNote(!showNote)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showNote ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showNote ? <EyeOff size={14}/> : <Eye size={14}/>} {showNote ? '·∫®n ghi ch√∫' : 'Hi·ªán ghi ch√∫'}
                      </button>
                    </div>
                    <button onClick={exportExcel} disabled={students.length === 0} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-black uppercase hover:bg-emerald-700 shadow-md transition-all disabled:opacity-50">
                      <Download size={14}/> T·∫£i Excel
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-2xl border-2 border-slate-400 shadow-2xl overflow-hidden mb-8">
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse min-w-[1200px]">
                      <thead>
                        <tr className="bg-slate-200 border-b-2 border-slate-400">
                          <th className="p-4 text-center text-[10px] font-black uppercase w-12 border-r border-slate-400 sticky left-0 bg-slate-200 z-10">STT</th>
                          <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400 sticky left-12 bg-slate-200 z-10">H·ªçc sinh</th>
                          {viewMode === 'specific' ? (showLevel && SPECIFIC_COMPETENCIES.map(c => <th key={c.id} className="p-4 text-center text-[9px] font-black uppercase border-r border-slate-400 w-24">{c.name}</th>)) : (showLevel && <th className="p-4 text-center text-[10px] font-black uppercase w-32 border-r border-slate-400">M·ª©c</th>)}
                          {showNote && <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400">Ghi ch√∫</th>}
                          <th className={`p-4 text-center text-[10px] font-black uppercase ${viewMode === 'specific' ? 'min-w-[400px]' : ''}`}>Nh·∫≠n x√©t chi ti·∫øt</th>
                          <th className="p-4 w-24 text-center text-[10px] font-black uppercase">G·ª≠i</th>
                          <th className="p-4 w-10"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y-2 divide-slate-300">
                        {students.map((stu, idx) => (
                          <tr key={stu.id} className="hover:bg-indigo-50/50 transition-all">
                            <td className="p-3 text-center text-xs font-bold text-slate-400 border-r border-slate-400 sticky left-0 bg-slate-50">{idx + 1}</td>
                            <td className="p-3 border-r border-slate-400 text-left sticky left-12 bg-white z-0"><span className="font-black text-slate-800 text-sm uppercase">{stu.name}</span></td>
                            {viewMode === 'specific' ? (showLevel && SPECIFIC_COMPETENCIES.map(c => (
                              <td key={c.id} className="p-1 border-r border-slate-400">
                                <div className="flex justify-center gap-0.5">
                                  {['T', 'ƒê', 'C'].map(lv => (
                                    <button key={lv} onClick={() => updateCell(stu.id, `level_${c.id}`, lv)} className={`w-6 h-6 rounded font-black text-[9px] ${studentData[stu.id]?.[`level_${c.id}`] === lv ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
                                  ))}
                                </div>
                              </td>
                            ))) : (showLevel && (
                              <td className="p-3 border-r border-slate-400">
                                <div className="flex justify-center gap-1">
                                  {(viewMode === 'subject' ? ['T', 'H', 'C'] : ['T', 'ƒê', 'C']).map(lv => (
                                    <button key={lv} onClick={() => updateCell(stu.id, 'level', lv)} className={`w-8 h-8 rounded-lg font-black text-[10px] ${studentData[stu.id]?.level === lv ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
                                  ))}
                                </div>
                              </td>
                            ))}
                            {showNote && <td className="p-3 border-r border-slate-400"><EditableCell value={studentData[stu.id]?.note} onSave={(val) => updateCell(stu.id, 'note', val)} className="w-full bg-transparent text-xs font-bold text-indigo-700 outline-none text-left" /></td>}
                            <td className="p-3 text-left"><EditableCell value={studentData[stu.id]?.comment} onSave={(val) => updateCell(stu.id, 'comment', val)} className="w-full bg-transparent text-sm font-medium border-none outline-none text-slate-700 text-left leading-relaxed" /></td>
                            <td className="p-3 text-center border-l border-slate-200"><button disabled={!studentData[stu.id]?.comment} onClick={() => handleSendZalo(stu.id)} className={`p-2.5 rounded-full mx-auto shadow-sm ${copySuccess === stu.id ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white disabled:opacity-30'}`}>{copySuccess === stu.id ? <CheckCircle2 size={18} /> : <ZaloIcon size={18} />}</button></td>
                            <td className="p-3 text-center"><button onClick={() => setConfirmDelete({ type: 'student', id: stu.id, name: stu.name })} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ) : <div className="py-24 text-center bg-white rounded-3xl border-2 border-dashed border-slate-400 font-black text-slate-400 uppercase">Ch·ªçn th√¥ng tin l·ªõp h·ªçc</div>}
          </main>

          <footer className="max-w-7xl mx-auto w-full px-6 py-4 mt-8 bg-white/80 rounded-t-3xl border-t border-slate-200">
            <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                <div className="text-left italic">{AUTHOR_NAME} ‚Ä¢ {AUTHOR_PHONE}</div>
                <div className="text-right">H·ªá th·ªëng ƒê√°nh gi√° TH Kh√°nh B√¨nh ¬© {new Date().getFullYear()}</div>
            </div>
          </footer>

          {modalType && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
              <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-left">
                <h3 className="text-xl font-black uppercase text-slate-800 mb-6">{editItem ? "S·ª≠a" : "Th√™m m·ªõi"}</h3>
                {modalType === 'student' ? <textarea autoFocus className="w-full h-64 p-4 bg-slate-50 border-2 border-slate-300 rounded-xl mb-6 text-left font-bold outline-none" placeholder="D√°n danh s√°ch h·ªçc sinh..." value={bulkInput} onChange={e => setBulkInput(e.target.value)}/> : <input autoFocus className="w-full p-4 bg-slate-50 border-2 border-slate-300 rounded-xl font-bold mb-6 text-left outline-none" value={inputValue} onChange={e => setInputValue(e.target.value)}/>}
                <div className="flex gap-4"><button onClick={() => setModalType(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={() => modalType === 'student' ? (async () => {
                  if (!bulkInput.trim()) return;
                  const names = bulkInput.split('\n').map(n => n.trim()).filter(n => n !== '');
                  const col = colStudents(selectedYearId, selectedClassId);
                  for (const name of names) await col.add({ name, createdAt: Date.now() });
                  setBulkInput(''); setModalType(null);
                })() : (async () => {
                  if (!inputValue.trim()) return;
                  const colName = modalType === 'year' ? 'years' : modalType === 'class' ? 'classes' : modalType === 'month' ? 'months' : 'subjects';
                  if (editItem) {
                    await rootArtifacts().collection(colName).doc(editItem.id).update({ name: inputValue });
                  } else {
                    await rootArtifacts().collection(colName).add({ name: inputValue, createdAt: Date.now() });
                  }
                  setInputValue(''); setModalType(null);
                })()} className="flex-[2] py-4 bg-indigo-600 text-white font-black rounded-xl uppercase text-[10px]">L∆∞u</button></div>
              </div>
            </div>
          )}

          {confirmDelete && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
              <div className="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl">
                <div className="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldAlert size={32} /></div>
                <h3 className="text-lg font-black mb-2 uppercase">X√°c nh·∫≠n x√≥a</h3>
                <p className="text-slate-500 text-sm mb-6">X√≥a <span className="text-red-600 font-bold">"{confirmDelete.name}"</span>?</p>
                <div className="flex gap-4"><button onClick={() => setConfirmDelete(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={async () => {
                  if (confirmDelete.type === 'student') {
                    await colStudents(selectedYearId, selectedClassId).doc(confirmDelete.id).delete();
                  } else {
                    const collectionName = confirmDelete.type === 'year' ? 'years' : confirmDelete.type === 'class' ? 'classes' : confirmDelete.type === 'month' ? 'months' : 'subjects';
                    await rootArtifacts().collection(collectionName).doc(confirmDelete.id).delete();
                  }
                  setConfirmDelete(null);
                }} className="flex-1 py-4 bg-red-600 text-white font-black rounded-xl uppercase text-[10px]">X√≥a</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render to #root
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>