<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ƒê√ÅNH GI√Å TH∆Ø·ªúNG XUY√äN ‚Äî TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    textarea.resize-none { resize: none; }
    .sticky-left { position: sticky; left: 0; z-index: 10; background: white; }
  </style>
</head>
<body class="bg-[#F8FAFC] font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // NOTE: makeEmojiIcon now accepts className so we can pass animate-spin to Loader2
    const makeEmojiIcon = (emoji) => ({ size = 16, className = '' }) => (<span className={className} style={{ fontSize: size }} aria-hidden>{emoji}</span>);
    const Plus = makeEmojiIcon('‚ûï'), Trash2 = makeEmojiIcon('üóëÔ∏è'), LayoutGrid = makeEmojiIcon('üß©'),
      Calendar = makeEmojiIcon('üìÖ'), BookOpen = makeEmojiIcon('üìñ'), UserPlus = makeEmojiIcon('üë§‚ûï'),
      Sparkles = makeEmojiIcon('‚ú®'), Loader2 = makeEmojiIcon('‚è≥'), Wand2 = makeEmojiIcon('ü™Ñ'),
      GraduationCap = makeEmojiIcon('üéì'), Edit2 = makeEmojiIcon('‚úèÔ∏è'), Eye = makeEmojiIcon('üëÅÔ∏è'),
      EyeOff = makeEmojiIcon('üôà'), Download = makeEmojiIcon('‚¨áÔ∏è'), ShieldAlert = makeEmojiIcon('üõ°Ô∏è'),
      CheckCircle2 = makeEmojiIcon('‚úÖ'), User = makeEmojiIcon('üë§'), Star = makeEmojiIcon('‚≠ê'),
      Settings = makeEmojiIcon('‚öôÔ∏è');

    const ZaloIcon = ({ size = 16 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="M22.507 11.23c-.156-.464-.34-.916-.548-1.353-.207-.436-.45-.858-.72-1.26a10.023 10.023 0 0 0-1.077-1.378 10.662 10.662 0 0 0-1.428-1.265 11.996 11.996 0 0 0-1.742-1.082A13.437 13.437 0 0 0 14.885 4.1a14.897 14.897 0 0 0-2.264-.474c-.38-.046-.763-.075-1.147-.087-.384-.012-.767-.008-1.15.012-.383.02-.764.055-1.145.105-.38.05-.758.115-1.134.195a14.864 14.864 0 0 0-2.22.65c-.358.13-.71.277-1.054.44a11.905 11.905 0 0 0-1.928 1.157 10.323 10.323 0 0 0-1.547 1.455c-.23.272-.44.558-.626.858a9.146 9.146 0 0 0-.825 2.022 8.79 8.79 0 0 0-.256 2.115c.01.353.04.706.087 1.055.048.35.114.697.198 1.04.084.343.187.68.307 1.01.12.33.256.654.407.97.15.316.315.626.494.927.18.3.37.593.578.877.207.284.426.56.654.825l-.578 2.316c-.052.207-.063.424-.032.636.03.21.096.413.195.6a1.442 1.442 0 0 0 .61.624c.24.13.51.196.78.196a1.517 1.517 0 0 0 .584-.117l3.522-1.507c.394.135.795.247 1.202.333.407.086.82.147 1.236.183.416.036.834.048 1.253.036.418-.012.836-.048 1.25-.108a14.892 14.892 0 0 0 2.417-.63 12.01 12.01 0 0 0 2.15-1.045 10.323 10.323 0 0 0 1.763-1.42 9.074 9.074 0 0 0 1.233-1.69 8.72 8.72 0 0 0 .864-2.128 9.052 9.052 0 0 0 .04-2.227z"/></svg>
    );

    // Firebase config (kept)
    const myFirebaseConfig = {
      apiKey: "AIzaSyCuomTR3xRgkk4YLCvc7bCKR2chx--AxvA",
      authDomain: "th-khanh-binh-manager.firebaseapp.com",
      projectId: "th-khanh-binh-manager",
      storageBucket: "th-khanh-binh-manager.firebasestorage.app",
      messagingSenderId: "772130590846",
      appId: "1:772130590846:web:108a05c64e2c5083ce882f"
    };
    if (!firebase.apps.length) firebase.initializeApp(myFirebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = 'th-khanh-binh-manager';

    const AUTHOR_NAME = "Tr·∫ßn Tr·ªçng Kim";
    const AUTHOR_PHONE = "0964567806";

    // Data arrays (v1)
    const QUALITIES = [
      { id: 'patriotic', name: 'Y√™u n∆∞·ªõc', prompt: 'Y√™u thi√™n nhi√™n, di s·∫£n, c√≥ √Ω th·ª©c b·∫£o v·ªá m√¥i tr∆∞·ªùng, t·ª± h√†o v·ªÅ qu√™ h∆∞∆°ng.' },
      { id: 'kind', name: 'Nh√¢n √°i', prompt: 'Y√™u th∆∞∆°ng m·ªçi ng∆∞·ªùi, s·∫µn s√†ng gi√∫p ƒë·ª° b·∫°n b√®, t√¥n tr·ªçng s·ª± kh√°c bi·ªát.' },
      { id: 'diligent', name: 'ChƒÉm ch·ªâ', prompt: 'T·ª± gi√°c h·ªçc t·∫≠p, ham h·ªçc h·ªèi, y√™u lao ƒë·ªông, c√≥ tr√°ch nhi·ªám v·ªõi vi·ªác h·ªçc.' },
      { id: 'honest', name: 'Trung th·ª±c', prompt: 'Th·∫≠t th√† trong h·ªçc t·∫≠p v√† sinh ho·∫°t, d√°m nh·∫≠n l·ªói, kh√¥ng gian l·∫≠n.' },
      { id: 'responsible', name: 'Tr√°ch nhi·ªám', prompt: 'C√≥ √Ω th·ª©c v·ªõi b·∫£n th√¢n, gia ƒë√¨nh v√† t·∫≠p th·ªÉ, ho√†n th√†nh t·ªët nhi·ªám v·ª•.' }
    ];

    const GENERAL_COMPETENCIES = [
      { id: 'self_control', name: 'T·ª± ch·ªß v√† t·ª± h·ªçc', prompt: 'Bi·∫øt t·ª± th·ª±c hi·ªán nhi·ªám v·ª•, ƒëi·ªÅu ch·ªânh c·∫£m x√∫c, c√≥ th√≥i quen t·ª± h·ªçc.' },
      { id: 'communication', name: 'Giao ti·∫øp v√† h·ª£p t√°c', prompt: 'Bi·∫øt l·∫Øng nghe, tr√¨nh b√†y √Ω ki·∫øn, ph·ªëi h·ª£p t·ªët khi l√†m vi·ªác nh√≥m.' },
      { id: 'problem_solving', name: 'Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v√† s√°ng t·∫°o', prompt: 'Bi·∫øt ph√°t hi·ªán v·∫•n ƒë·ªÅ ƒë∆°n gi·∫£n, ƒë·ªÅ xu·∫•t c√°ch gi·∫£i quy·∫øt m·ªõi m·∫ª.' }
    ];

    const SPECIFIC_COMPETENCIES = [
      { id: 'lang', name: 'Ng√¥n ng·ªØ', prompt: 'ƒê·ªçc l∆∞u lo√°t, di·ªÖn c·∫£m. N√≥i m·∫°ch l·∫°c. Vi·∫øt ƒë√∫ng ch√≠nh t·∫£, s·∫°ch ƒë·∫πp.' },
      { id: 'math', name: 'T√≠nh to√°n', prompt: 'Th·ª±c hi·ªán t·ªët c√°c ph√©p t√≠nh. V·∫≠n d·ª•ng ki·∫øn th·ª©c v√†o th·ª±c t·∫ø ch√≠nh x√°c.' },
      { id: 'sci', name: 'Khoa h·ªçc', prompt: 'Quan s√°t t·ªët th·∫ø gi·ªõi t·ª± nhi√™n. C√≥ √Ω th·ª©c b·∫£o v·ªá s·ª©c kh·ªèe, m√¥i tr∆∞·ªùng.' },
      { id: 'tech', name: 'C√¥ng ngh·ªá', prompt: 'S·ª≠ d·ª•ng b·ªô ƒë·ªì d√πng h·ªçc t·∫≠p hi·ªáu qu·∫£. Bi·∫øt d√πng thi·∫øt b·ªã ƒë∆°n gi·∫£n.' },
      { id: 'it', name: 'Tin h·ªçc', prompt: 'S·ª≠ d·ª•ng thi·∫øt b·ªã s·ªë c∆° b·∫£n. Thu th·∫≠p th√¥ng tin qua h√¨nh ·∫£nh g·ª£i √Ω.' },
      { id: 'art', name: 'Th·∫©m mƒ©', prompt: 'C·∫£m nh·∫≠n v·∫ª ƒë·∫πp √¢m nh·∫°c, h·ªôi h·ªça. Di·ªÖn ƒë·∫°t c·∫£m x√∫c qua ngh·ªá thu·∫≠t.' },
      { id: 'phys', name: 'Th·ªÉ ch·∫•t', prompt: 'T·ª± gi√°c t·∫≠p luy·ªán. T√≠ch c·ª±c tham gia tr√≤ ch∆°i v·∫≠n ƒë·ªông.' }
    ];

    const SUBJECT_TO_COMPETENCY_MAP = {
      'Ti·∫øng Vi·ªát': 'lang',
      'To√°n': 'math',
      'Khoa h·ªçc': 'sci',
      'T·ª± nhi√™n v√† X√£ h·ªôi': 'sci',
      'C√¥ng ngh·ªá': 'tech',
      'Tin h·ªçc': 'it',
      'Mƒ© thu·∫≠t': 'art',
      'Gi√°o d·ª•c Th·ªÉ ch·∫•t': 'phys'
    };

    const EditableCell = ({ value, onSave, className }) => {
      const [local, setLocal] = useState(value || '');
      const ref = useRef(null);
      const t = useRef(null);
      useEffect(() => { setLocal(value || ''); setTimeout(()=>{ if (ref.current){ ref.current.style.height='auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; } },0); }, [value]);
      const handle = (e) => {
        const v = e.target.value;
        setLocal(v);
        if (ref.current){ ref.current.style.height='auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; }
        if (t.current) clearTimeout(t.current);
        t.current = setTimeout(()=>onSave(v), 800);
      };
      return <textarea ref={ref} rows={1} value={local} onChange={handle} className={`${className} overflow-hidden whitespace-pre-wrap`} />;
    };

    const rootArtifacts = () => db.collection('artifacts').doc(appId).collection('public').doc('data');
    const colYears = () => rootArtifacts().collection('years');
    const colClasses = () => rootArtifacts().collection('classes');
    const colMonths = () => rootArtifacts().collection('months');
    const colSubjects = () => rootArtifacts().collection('subjects');
    const colCommentsForKey = (key) => rootArtifacts().collection('comments').doc(key).collection('entries');
    const colStudents = (yearId, classId) => rootArtifacts().collection('years').doc(yearId).collection('classes').doc(classId).collection('students');

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    const App = () => {
      const [user, setUser] = useState(null);
      const [years, setYears] = useState([]);
      const [classes, setClasses] = useState([]);
      const [months, setMonths] = useState([]);
      const [subjects, setSubjects] = useState([]);
      const [students, setStudents] = useState([]);
      const [studentData, setStudentData] = useState({});

      const [selectedYearId, setSelectedYearId] = useState('');
      const [selectedClassId, setSelectedClassId] = useState('');
      const [selectedMonthId, setSelectedMonthId] = useState('');
      const [selectedSubId, setSelectedSubId] = useState('');

      const [viewMode, setViewMode] = useState('subject');
      const [showLevel, setShowLevel] = useState(true);
      const [showNote, setShowNote] = useState(true);

      const [modalType, setModalType] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [editItem, setEditItem] = useState(null);
      const [inputValue, setInputValue] = useState('');
      const [bulkInput, setBulkInput] = useState('');
      const [aiPrompt, setAiPrompt] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [copySuccess, setCopySuccess] = useState(null);
      const [isAuthValid, setIsAuthValid] = useState(true);

      // keys
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [gApiKey1, setGApiKey1] = useState('');
      const [gApiKey2, setGApiKey2] = useState('');
      const [gApiKey3, setGApiKey3] = useState('');
      const [gApiKey4, setGApiKey4] = useState('');
      const [gApiKey5, setGApiKey5] = useState('');
      const [showKey1, setShowKey1] = useState(false);
      const [showKey2, setShowKey2] = useState(false);
      const [showKey3, setShowKey3] = useState(false);
      const [showKey4, setShowKey4] = useState(false);
      const [showKey5, setShowKey5] = useState(false);
      const [apiError, setApiError] = useState('');

      useEffect(() => {
        const _v = (s) => btoa(unescape(encodeURIComponent(s)));
        if (_v(AUTHOR_NAME) !== "VHLhuqduIFRy4buNbmcgS2lt" || _v(AUTHOR_PHONE) !== "MDk2NDU2NzgwNg==") setIsAuthValid(false);
      }, []);
      useEffect(() => {
        const init = async () => {
          try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token); else await auth.signInAnonymously(); } catch(e){ await auth.signInAnonymously(); }
        };
        init();
        const unsub = auth.onAuthStateChanged(u => setUser(u));
        return () => unsub && unsub();
      }, []);
      useEffect(() => {
        try {
          setGApiKey1(localStorage.getItem('gstudio_api_key_1')||'');
          setGApiKey2(localStorage.getItem('gstudio_api_key_2')||'');
          setGApiKey3(localStorage.getItem('gstudio_api_key_3')||'');
          setGApiKey4(localStorage.getItem('gstudio_api_key_4')||'');
          setGApiKey5(localStorage.getItem('gstudio_api_key_5')||'');
        } catch(e){}
      }, []);
      useEffect(() => {
        try {
          if (gApiKey1) localStorage.setItem('gstudio_api_key_1', gApiKey1); else localStorage.removeItem('gstudio_api_key_1');
          if (gApiKey2) localStorage.setItem('gstudio_api_key_2', gApiKey2); else localStorage.removeItem('gstudio_api_key_2');
          if (gApiKey3) localStorage.setItem('gstudio_api_key_3', gApiKey3); else localStorage.removeItem('gstudio_api_key_3');
          if (gApiKey4) localStorage.setItem('gstudio_api_key_4', gApiKey4); else localStorage.removeItem('gstudio_api_key_4');
          if (gApiKey5) localStorage.setItem('gstudio_api_key_5', gApiKey5); else localStorage.removeItem('gstudio_api_key_5');
        } catch(e){}
      }, [gApiKey1,gApiKey2,gApiKey3,gApiKey4,gApiKey5]);

      useEffect(() => { setApiError(''); }, [gApiKey1,gApiKey2,gApiKey3,gApiKey4,gApiKey5, aiPrompt, selectedYearId, selectedClassId, selectedMonthId, selectedSubId, viewMode]);

      useEffect(() => {
        if (!user || !isAuthValid) return;
        const unsubYears = colYears().onSnapshot(s => setYears(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))));
        const unsubCla = colClasses().onSnapshot(s => setClasses(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>a.name.localeCompare(b.name,'vi',{numeric:true}))));
        const unsubMon = colMonths().onSnapshot(s => setMonths(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))));
        const unsubSub = colSubjects().onSnapshot(s => setSubjects(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>a.name.localeCompare(b.name,'vi'))));
        return () => { unsubYears && unsubYears(); unsubCla && unsubCla(); unsubMon && unsubMon(); unsubSub && unsubSub(); };
      }, [user, isAuthValid]);

      useEffect(() => {
        if (!user || !selectedClassId || !selectedYearId || !isAuthValid) { setStudents([]); return; }
        const unsub = colStudents(selectedYearId, selectedClassId).onSnapshot(s => setStudents(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0))));
        return () => unsub && unsub();
      }, [user, selectedClassId, selectedYearId, isAuthValid]);

      useEffect(() => {
        if (!user || !selectedMonthId || !selectedClassId || !selectedYearId || !isAuthValid) { setStudentData({}); return; }
        if (viewMode === 'subject' && !selectedSubId) { setStudentData({}); return; }
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const unsub = colCommentsForKey(key).onSnapshot(s => { const d={}; s.forEach(doc => d[doc.id] = doc.data()); setStudentData(d); });
        return () => unsub && unsub();
      }, [user, selectedSubId, selectedMonthId, selectedClassId, selectedYearId, viewMode, isAuthValid]);

      const updateCell = async (studentId, field, value) => {
        if (!user || !isAuthValid) return;
        const key = viewMode === 'subject' ? `${selectedYearId}_${selectedSubId}_${selectedMonthId}_${selectedClassId}` : `${selectedYearId}_${viewMode}_${selectedMonthId}_${selectedClassId}`;
        const docRef = colCommentsForKey(key).doc(studentId);

        let finalValue = value;
        const currentData = studentData[studentId];
        if (currentData && currentData[field] === value) finalValue = "";

        await docRef.set({ [field]: finalValue }, { merge: true });

        if (viewMode === 'subject' && field === 'level') {
          const subjectName = subjects.find(s => s.id === selectedSubId)?.name;
          const targetCompId = SUBJECT_TO_COMPETENCY_MAP[subjectName];
          if (targetCompId) {
            const compLevelValue = (finalValue === 'H') ? 'ƒê' : finalValue;
            const compKey = `${selectedYearId}_specific_${selectedMonthId}_${selectedClassId}`;
            const compDocRef = colCommentsForKey(compKey).doc(studentId);
            await compDocRef.set({ [`level_${targetCompId}`]: compLevelValue }, { merge: true });
          }
        }
      };

      const getAvailableKeys = () => [gApiKey1,gApiKey2,gApiKey3,gApiKey4,gApiKey5].map(k => (k||'').trim()).filter(Boolean);

      const callStudio = async (key, userPrompt, systemPrompt) => {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(key)}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=>''); const err = new Error(`HTTP ${res.status} ${res.statusText}${txt?`: ${txt}`:''}`); err.status = res.status; throw err;
        }
        const result = await res.json().catch(()=>null);
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()?.replace(/[*\-#"']/g, '');
        if (!text) throw new Error('API tr·∫£ v·ªÅ k·∫øt qu·∫£ r·ªóng ho·∫∑c kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.');
        return text;
      };

      const runAI = async () => {
        if (!isAuthValid) return;
        setApiError('');

        const targets = students.filter(s => {
          const d = studentData[s.id] || {};
          if (viewMode === 'subject') return d.level && !d.comment;
          if (viewMode === 'competency' || viewMode === 'quality') return (QUALITIES.some(q => d[`level_${q.id}`]) || GENERAL_COMPETENCIES.some(g => d[`level_${g.id}`])) && !d.comment;
          if (viewMode === 'specific') return SPECIFIC_COMPETENCIES.some(c => d[`level_${c.id}`]) && !d.comment;
          return false;
        });

        if (!targets.length) { alert('Kh√¥ng c√≥ h·ªçc sinh c·∫ßn nh·∫≠n x√©t‚ù§Ô∏èVui l√≤ng ch·ªçn m·ª©c ƒë·∫°t cho h·ªçc sinh'); return; }

        const keys = getAvailableKeys();
        if (!keys.length) { setApiError('Vui l√≤ng c·∫•u h√¨nh √≠t nh·∫•t 1 API key trong C√†i ƒë·∫∑t (‚öôÔ∏è).'); return; }

        setIsGenerating(true);

        for (let idx = 0; idx < targets.length; idx++) {
          const stu = targets[idx];
          const data = studentData[stu.id] || {};
          let systemPrompt = "";
          let contextInfo = "";
          
          if (viewMode === 'subject') {
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t M√¥n h·ªçc. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i kho·∫£ng 20 t·ª´. 
            - Nh·∫≠n x√©t t·∫≠p chung v√†o vi·ªác h·ªçc sinh l√†m, th·ª±c hi·ªán ƒë∆∞·ª£c.
            - Kh√¥ng d√πng l·∫°i t√™n g·ªçi m√¥n h·ªçc.
            - Kh√¥ng d√πng t·ª´ ho√†n th√†nh t·ªët cho m·ª©c H v√† m·ª©c C.
            - M·ª©c T (T·ªët): Khen ng·ª£i th√†nh t√≠ch.
            - M·ª©c H (Ho√†n th√†nh): Khen nh·∫π, n√™u h∆∞·ªõng ph√°t huy.
            - M·ª©c C (Ch∆∞a ho√†n th√†nh): Khen kh√≠ch l·ªá, n√™u h·∫°n ch·∫ø c·ª• th·ªÉ v√† h∆∞·ªõng kh·∫Øc ph·ª•c.`;
            contextInfo = `M√¥n: ${subjects.find(s=>s.id===selectedSubId)?.name}. M·ª©c: ${data.level}.`;
          } else if (viewMode === 'competency' || viewMode === 'quality') {
            const itemType = viewMode === 'competency' ? 'NƒÉng l·ª±c chung' : 'Ph·∫©m ch·∫•t';
            const components = viewMode === 'competency' ? GENERAL_COMPETENCIES : QUALITIES;
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t t·ªïng h·ª£p ${itemType}. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i kho·∫£ng 30 t·ª´.
            D·ª±a v√†o c√°c m·ª©c ƒë·∫°t (T/ƒê/C) c·ªßa t·ª´ng th√†nh ph·∫ßn ƒë·ªÉ vi·∫øt c√¢u vƒÉn m·∫°ch l·∫°c.
            - Kh√¥ng li·ªát k√™ danh s√°ch, ph·∫£i vi·∫øt th√†nh c√¢u.
            - Tuy·ªát ƒë·ªëi kh√¥ng d√πng t·ª´ ho√†n th√†nh t·ªët cho m·ª©c ƒê (ƒê·∫°t).
            - Nh·∫≠n x√©t v√†o h√†nh vi, th√°i ƒë·ªô c·ª• th·ªÉ.
            - M·ª©c T (T·ªët): khen ng·ª£i th√†nh t√≠ch.
            - M·ª©c ƒê (ƒê·∫°t): N√™u h∆∞·ªõng ph√°t huy.
            - M·ª©c C (Ch∆∞a ho√†n th√†nh) N√™u h·∫°n ch·∫ø v√† h∆∞·ªõng kh·∫Øc ph·ª•c.`;
            const details = components.map(c => {
              const lv = data[`level_${c.id}`];
              return lv ? `${c.name} (${lv}): ${c.prompt}` : null;
            }).filter(Boolean).join('. ');
            contextInfo = `${itemType} th√†nh ph·∫ßn: ${details}`;
          } else if (viewMode === 'specific') {
            systemPrompt = `B·∫°n l√† GV Ti·ªÉu h·ªçc. Vi·∫øt nh·∫≠n x√©t NƒÉng l·ª±c ƒë·∫∑c th√π t·ªïng h·ª£p. Quy t·∫Øc: B·∫Øt ƒë·∫ßu b·∫±ng 'Em'. D√†i kho·∫£ng 40 t·ª´. 
            D·ª±a v√†o m·ª©c ƒë·ªô T/ƒê/C c·ªßa c√°c nƒÉng l·ª±c th√†nh ph·∫ßn ƒë·ªÉ vi·∫øt c√¢u nh·∫≠n x√©t M·ªöI.
            KH√îNG li·ªát k√™ t√™n nƒÉng l·ª±c. 
            - Kh√¥ng d√πng l·∫°i t√™n g·ªçi c√°c nƒÉng l·ª±c.
            Tuy·ªát ƒë·ªëi kh√¥ng d√πng t·ª´ ho√†n th√†nh t·ªët cho m·ª©c ƒê (ƒê·∫°t).
            - Nh·∫≠n x√©t v√†o h√†nh vi, th√°i ƒë·ªô c·ª• th·ªÉ.
            - M·ª©c T (T·ªët): khen ng·ª£i th√†nh t√≠ch.
            - M·ª©c ƒê (ƒê·∫°t): N√™u h∆∞·ªõng ph√°t huy.
            - M·ª©c C (Ch∆∞a ho√†n th√†nh) N√™u h·∫°n ch·∫ø v√† h∆∞·ªõng kh·∫Øc ph·ª•c.`;
            const details = SPECIFIC_COMPETENCIES.map(c => {
              const lv = data[`level_${c.id}`];
              return lv ? `${c.name} (${lv}): ${c.prompt}` : null;
            }).filter(Boolean).join('. ');
            contextInfo = `D·ªØ li·ªáu ph√¢n m√¥n: ${details}`;
          }

          const userPrompt = `${contextInfo}. L∆∞u √Ω th√™m c·ªßa GV: ${aiPrompt}. Ghi ch√∫ ri√™ng: ${data.note || 'Kh√¥ng'}.`;

          const startIndex = idx % keys.length;
          let generated = null;
          let lastErr = null;

          for (let offset = 0; offset < keys.length; offset++) {
            const keyIndex = (startIndex + offset) % keys.length;
            const key = keys[keyIndex];
            try {
              generated = await callStudio(key, userPrompt, systemPrompt);
              await updateCell(stu.id, 'comment', generated);
              lastErr = null;
              break;
            } catch (err) {
              lastErr = err;
              console.warn(`Key ${keyIndex+1} failed for ${stu.name}:`, err.message || err);
              continue;
            }
          }

          if (lastErr) {
            const msg = `Kh√¥ng th·ªÉ t·∫°o nh·∫≠n x√©t cho ${stu.name}. L·ªói: ${lastErr?.message || 'Kh√¥ng r√µ'}.`;
            console.error(msg);
            setApiError(prev => prev ? prev + '\n' + msg : msg);
          }

         // Random pause between 3 and 5 seconds
          const pauseMs = 3000 + Math.floor(Math.random() * 2001); // 3000..5000
          await sleep(pauseMs);
        }


        setIsGenerating(false);
        if (!apiError) alert('HO√ÄN T·∫§T NH·∫¨N X√âT.');
      };

      const handleSendZalo = (studentId) => {
        if (!isAuthValid) return;
        const stu = students.find(s => s.id === studentId);
        const data = studentData[studentId] || {};
        if (!stu || !data.comment) return;
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c chung' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NƒÉng l·ª±c ƒë·∫∑c th√π'));
        const message = `‚ú® TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH ‚ú®\nüíå TH∆Ø KHEN G·ª¨I GIA ƒê√åNH EM: ${stu.name.toUpperCase()}\n---------------------------\nüåà L·ªõp: ${classes.find(c=>c.id===selectedClassId)?.name}\nüìò N·ªôi dung: ${subName} (${months.find(m=>m.id===selectedMonthId)?.name})\n\nüìù Nh·∫≠n x√©t:\n"${data.comment}"\n\n‚ù§Ô∏è Ch√∫c con lu√¥n chƒÉm ngoan!\n‚ú®GIA S∆Ø TI·ªÇU H·ªåC‚ú®: https://roboki.vn/`;
        const el = document.createElement('textarea'); el.value = message; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        setCopySuccess(studentId); setTimeout(()=>setCopySuccess(null), 2000); window.open('https://chat.zalo.me/', '_blank');
      };

      // EXPORT EXCEL: Improved formatting to ensure headers centered, visible, table with borders, and comments wrapped with row heights set
      const exportExcel = () => {
        if (!students.length || !window.XLSX) return;
        const className = classes.find(c => c.id === selectedClassId)?.name || 'Lop';
        const monthName = months.find(m => m.id === selectedMonthId)?.name || 'Thang';
        const subName = viewMode === 'subject' ? subjects.find(s => s.id === selectedSubId)?.name : (viewMode === 'competency' ? 'NƒÉng l·ª±c' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NL ƒê·∫∑c th√π'));

        // Header rows
        const rows = [];
        rows.push(['B·∫¢NG NH·∫¨N X√âT ƒê√ÅNH GI√Å H·ªåC SINH']);
        rows.push(['TR∆Ø·ªúNG TI·ªÇU H·ªåC KH√ÅNH B√åNH']);
        rows.push([`L·ªõp: ${className}`, '', `Th·ªùi gian: ${monthName}`]);
        rows.push([`N·ªôi dung: ${subName}`]);
        rows.push([]); // spacer

        // Build headers/body by mode
        let headers = [];
        let bodyRows = [];

        if (viewMode === 'subject') {
          headers = ['STT','H·ªå V√Ä T√äN','M·ª®C ƒê·∫†T','NH·∫¨N X√âT'];
          students.forEach((s,i) => {
            const d = studentData[s.id] || {};
            bodyRows.push([i+1, (s.name||'').toUpperCase(), d.level || '', d.comment || '']);
          });
        } else if (viewMode === 'competency') {
          headers = ['STT','H·ªå V√Ä T√äN', ...GENERAL_COMPETENCIES.map(c => c.name), 'NH·∫¨N X√âT'];
          students.forEach((s,i) => {
            const d = studentData[s.id] || {};
            bodyRows.push([i+1, (s.name||'').toUpperCase(), ...GENERAL_COMPETENCIES.map(c => d[`level_${c.id}`] || ''), d.comment || '']);
          });
        } else if (viewMode === 'specific') {
          headers = ['STT','H·ªå V√Ä T√äN', ...SPECIFIC_COMPETENCIES.map(c => c.name), 'NH·∫¨N X√âT'];
          students.forEach((s,i) => {
            const d = studentData[s.id] || {};
            bodyRows.push([i+1, (s.name||'').toUpperCase(), ...SPECIFIC_COMPETENCIES.map(c => d[`level_${c.id}`] || ''), d.comment || '']);
          });
        } else if (viewMode === 'quality') {
          headers = ['STT','H·ªå V√Ä T√äN', ...QUALITIES.map(c => c.name), 'NH·∫¨N X√âT'];
          students.forEach((s,i) => {
            const d = studentData[s.id] || {};
            bodyRows.push([i+1, (s.name||'').toUpperCase(), ...QUALITIES.map(c => d[`level_${c.id}`] || ''), d.comment || '']);
          });
        }

        rows.push(headers);
        rows.push(...bodyRows);

        const wb = window.XLSX.utils.book_new();
        const ws = window.XLSX.utils.aoa_to_sheet(rows);

        // compute total columns
        const totalCols = headers.length;

        // merge title rows across columns
        ws['!merges'] = ws['!merges'] || [];
        ws['!merges'].push({ s: { r:0, c:0 }, e: { r:0, c: totalCols-1 } }); // title
        ws['!merges'].push({ s: { r:1, c:0 }, e: { r:1, c: totalCols-1 } }); // school
        ws['!merges'].push({ s: { r:3, c:0 }, e: { r:3, c: totalCols-1 } }); // content line

        // set column widths: STT narrow, Name medium, middle columns medium, comment wide
        const cols = [];
        cols.push({ wch: 6 }); // STT
        cols.push({ wch: 30 }); // Name
        const middleCount = totalCols - 3; // excluding STT, Name, Comment
        for (let i=0;i<middleCount;i++) cols.push({ wch: 14 });
        cols.push({ wch: 80 }); // comment
        ws['!cols'] = cols;

        // prepare row heights array
        ws['!rows'] = ws['!rows'] || [];

        // header row index
        const headerRowIndex = 5; // 0-based row index where headers are placed (we pushed title(0), school(1), class/time(2), content(3), spacer(4), headers(5))
        // set header row height
        ws['!rows'][headerRowIndex] = { hpt: 28 };

        // style each cell and set borders/wrap; also compute row heights for comment cells based on length
        const range = window.XLSX.utils.decode_range(ws['!ref']);
        // data starting row index
        const firstDataRow = headerRowIndex + 1;

        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellRef = window.XLSX.utils.encode_cell({ r:R, c:C });
            if (!ws[cellRef]) ws[cellRef] = { t:'s', v: '' };
            // default style
            ws[cellRef].s = {
              font: { name: "Arial", sz: 11 },
              alignment: { wrapText: true, vertical: "top", horizontal: "center" },
              border: {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
              }
            };

            // Title row formatting
            if (R === 0) {
              ws[cellRef].s.font = { name: "Arial", sz: 16, bold: true };
              ws[cellRef].s.alignment = { horizontal: "center", vertical: "center", wrapText: true };
              ws['!rows'][0] = ws['!rows'][0] || { hpt: 30 };
            }
            // school row
            if (R === 1) {
              ws[cellRef].s.font = { name: "Arial", sz: 12, bold: true };
              ws[cellRef].s.alignment = { horizontal: "center", vertical: "center", wrapText: true };
              ws['!rows'][1] = ws['!rows'][1] || { hpt: 20 };
            }
            // class/time row: row 2 -> allow 16
            if (R === 2) ws['!rows'][2] = ws['!rows'][2] || { hpt: 18 };
            // content row (3)
            if (R === 3) ws['!rows'][3] = ws['!rows'][3] || { hpt: 18 };

            // Header row styling
            if (R === headerRowIndex) {
              ws[cellRef].s.font = { name: "Arial", sz: 11, bold: true };
              ws[cellRef].s.fill = { fgColor: { rgb: "F3F4F6" } };
              ws[cellRef].s.alignment = { horizontal: "center", vertical: "center", wrapText: true };
            }

            // Body rows: left-align name and comment columns
            if (R >= firstDataRow) {
              // Name column (index 1) left align
              if (C === 1) ws[cellRef].s.alignment = { horizontal: "left", vertical: "top", wrapText: true };
              // Comment column is last column
              if (C === (totalCols - 1)) ws[cellRef].s.alignment = { horizontal: "left", vertical: "top", wrapText: true };
            }
          }
        }

        // set dynamic row heights for each data row based on comment length so content won't be hidden
        const approxCharsPerLine = 80; // matches column width wch:80
        for (let r = 0; r < bodyRows.length; r++) {
          const realRowIndex = firstDataRow + r;
          const comment = (bodyRows[r][totalCols-1] || '') + '';
          const lines = Math.max(1, Math.ceil(comment.length / approxCharsPerLine));
          // estimate height in points: ~ 15pt per line
          const height = Math.max(18, lines * 15);
          ws['!rows'][realRowIndex] = { hpt: height };
        }

        // append sheet and write file
        window.XLSX.utils.book_append_sheet(wb, ws, "NhanXet");
        try {
          window.XLSX.writeFile(wb, `NhanXet_${className}_${monthName}_${subName}.xlsx`);
        } catch (e) {
          window.XLSX.writeFile(wb, `NhanXet_${className}_${monthName}_${subName}.xlsx`);
        }
      };

      const SectionBox = ({ label, items, selectedId, onSelect, type, icon: Icon }) => (
        <div className="bg-white p-4 rounded-xl border-2 border-slate-300 shadow-sm flex flex-col gap-2">
          <div className="flex items-center justify-between mb-1">
            <span className="text-[11px] font-black text-slate-600 uppercase flex items-center gap-1.5"><Icon size={12}/> {label}</span>
            <div className="flex gap-1">
              {selectedId && (
                <>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setEditItem(item); setInputValue(item.name); setModalType(type); }} className="p-1 text-blue-500 hover:bg-blue-50 rounded"><Edit2 size={12}/></button>
                  <button onClick={() => { const item = items.find(i => i.id === selectedId); setConfirmDelete({ type, id: item.id, name: item.name }); }} className="p-1 hover:text-red-600"><Trash2 size={12}/></button>
                </>
              )}
              <button onClick={() => { setEditItem(null); setInputValue(''); setModalType(type); }} className="p-1 text-indigo-500"><Plus size={14}/></button>
            </div>
          </div>
          <select value={selectedId || ''} onChange={(e) => onSelect(e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-bold outline-none">
            <option value="">-- Ch·ªçn --</option>
            {items.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}
          </select>
        </div>
      );

      if (!isAuthValid) return <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white font-black">L·ªñI X√ÅC TH·ª∞C B·∫¢N QUY·ªÄN</div>;

      const renderLevelCells = (stu) => {
        const data = studentData[stu.id] || {};
        if (viewMode === 'competency') {
          return GENERAL_COMPETENCIES.map(c => (
            <td key={c.id} className="p-1 border-r border-slate-400">
              <div className="flex justify-center gap-0.5">
                {['T','ƒê','C'].map(lv => (
                  <button key={lv} onClick={() => updateCell(stu.id, `level_${c.id}`, lv)} className={`w-7 h-7 rounded font-black text-[9px] ${data[`level_${c.id}`] === lv ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
                ))}
              </div>
            </td>
          ));
        }
        if (viewMode === 'specific') {
          return SPECIFIC_COMPETENCIES.map(c => (
            <td key={c.id} className="p-1 border-r border-slate-400">
              <div className="flex justify-center gap-0.5">
                {['T','ƒê','C'].map(lv => (
                  <button key={lv} onClick={() => updateCell(stu.id, `level_${c.id}`, lv)} className={`w-7 h-7 rounded font-black text-[9px] ${data[`level_${c.id}`] === lv ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
                ))}
              </div>
            </td>
          ));
        }
        if (viewMode === 'quality') {
          return QUALITIES.map(c => (
            <td key={c.id} className="p-1 border-r border-slate-400">
              <div className="flex justify-center gap-0.5">
                {['T','ƒê','C'].map(lv => (
                  <button key={lv} onClick={() => updateCell(stu.id, `level_${c.id}`, lv)} className={`w-7 h-7 rounded font-black text-[9px] ${data[`level_${c.id}`] === lv ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
                ))}
              </div>
            </td>
          ));
        }
        const opts = ['T','H','C'];
        return (
          <td className="p-3 border-r border-slate-400">
            <div className="flex justify-center gap-1">
              {opts.map(lv => (
                <button key={lv} onClick={() => updateCell(stu.id, 'level', lv)} className={`w-8 h-8 rounded-lg font-black text-[10px] ${studentData[stu.id]?.level === lv ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}>{lv}</button>
              ))}
            </div>
          </td>
        );
      };

      return (
        // Add pt-28 so content is not hidden under the fixed header
        <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-12 font-sans text-left flex flex-col pt-28">
          {/* Header fixed to top */}
          <header className="fixed inset-x-0 top-0 z-50 bg-indigo-900 text-white p-6 shadow-xl border-b-4 border-indigo-700">
            <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center w-full gap-4">
              <div className="flex items-center gap-4">
                <div className="p-2 bg-white/20 rounded-xl"><GraduationCap size={32}/></div>
                <div className="flex flex-col">
                  <h1 className="text-xl font-black uppercase leading-none">ƒê√ÅNH GI√Å TH∆Ø·ªúNG XUY√äN</h1>
                  <span className="text-indigo-300 text-[12px] font-bold uppercase mt-1 italic">TI·ªÇU H·ªåC KH√ÅNH B√åNH - D·∫™N L·ªêI T∆Ø∆†NG LAI</span>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <div className="relative">
                  <div className="flex bg-indigo-950/50 p-1 rounded-xl gap-1">
                    {[
                      {id: 'subject', label: 'M√¥n h·ªçc'},
                      {id: 'competency', label: 'NƒÉng l·ª±c chung'},
                      {id: 'quality', label: 'Ph·∫©m ch·∫•t'},
                      {id: 'specific', label: 'NL ƒê·∫∑c th√π'}
                    ].map(m => (
                      <button key={m.id} onClick={() => setViewMode(m.id)} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${viewMode === m.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-300 hover:text-white'}`}>
                        {m.label}
                      </button>
                    ))}
                  </div>

                  {settingsOpen && (
                    <div className="absolute right-0 mt-3 w-96 bg-white text-slate-800 rounded-2xl shadow-2xl p-4 z-50 border border-slate-200">
                      <h4 className="font-black text-sm uppercase text-slate-600 mb-3 flex items-center gap-2"><Settings size={14}/> C√†i ƒë·∫∑t Studio AI (5 keys)</h4>
                      <div className="space-y-3">
                        {[
                          [gApiKey1, setGApiKey1, showKey1, setShowKey1, 'Key 1'],
                          [gApiKey2, setGApiKey2, showKey2, setShowKey2, 'Key 2'],
                          [gApiKey3, setGApiKey3, showKey3, setShowKey3, 'Key 3'],
                          [gApiKey4, setGApiKey4, showKey4, setShowKey4, 'Key 4'],
                          [gApiKey5, setGApiKey5, showKey5, setShowKey5, 'Key 5']
                        ].map(([val, setter, vis, setVis, label], i) => (
                          <div key={i}>
                            <label className="text-[11px] text-slate-500 font-black uppercase">{label}</label>
                            <div className="flex items-center gap-2 mt-1">
                              <input type={vis ? 'text':'password'} value={val} onChange={e=>setter(e.target.value)} placeholder={label} className="w-full p-2 bg-slate-50 border rounded-lg text-sm outline-none"/>
                              <button onClick={()=>setVis(!vis)} className="p-2 bg-white border rounded-lg text-sm">{vis ? <EyeOff size={14}/> : <Eye size={14}/>}</button>
                            </div>
                          </div>
                        ))}
                        <div className="flex gap-2 mt-2">
                          <button onClick={()=>setSettingsOpen(false)} className="flex-1 py-2 border rounded-lg font-black text-slate-600 text-[12px]">H·ªßy</button>
                          <button onClick={()=>setSettingsOpen(false)} className="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-black text-[12px]">L∆∞u & ƒê√≥ng</button>
                        </div>
                        <p className="text-[14px] text-slate-500">Vui l√≤ng li√™n h·ªá th·∫ßy Tr·∫ßn Tr·ªçng Kim. ƒêT: 0964567806.</p>
                      </div>
                    </div>
                  )}
                </div>

                <div className="relative">
                  <button onClick={()=>setSettingsOpen(!settingsOpen)} title="C√†i ƒë·∫∑t API Studio" className="p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white flex items-center gap-2">
                    <Settings size={18} />
                  </button>
                </div>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <SectionBox label="NƒÉm h·ªçc" icon={Calendar} items={years} selectedId={selectedYearId} onSelect={setSelectedYearId} type="year" />
            <SectionBox label="L·ªõp h·ªçc" icon={LayoutGrid} items={classes} selectedId={selectedClassId} onSelect={setSelectedClassId} type="class" />
            <SectionBox label="Th√°ng" icon={Calendar} items={months} selectedId={selectedMonthId} onSelect={setSelectedMonthId} type="month" />
            {viewMode === 'subject' ? <SectionBox label="M√¥n h·ªçc" icon={BookOpen} items={subjects} selectedId={selectedSubId} onSelect={setSelectedSubId} type="subject" /> : <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200 shadow-sm flex items-center justify-center font-black text-indigo-700 text-[10px] uppercase gap-2">{viewMode === 'quality' ? <Star size={14}/> : <User size={14}/>} {viewMode === 'competency' ? 'NƒÉng l·ª±c chung' : (viewMode === 'quality' ? 'Ph·∫©m ch·∫•t' : 'NL ƒê·∫∑c th√π')}</div>}
          </div>

          <main className="max-w-7xl mx-auto px-4 md:px-6 flex-1">
            {selectedYearId && selectedClassId && selectedMonthId && (viewMode !== 'subject' || selectedSubId) ? (
              <div className="space-y-6">
                <div className="bg-white rounded-2xl p-6 border-2 border-slate-300 shadow-sm flex flex-col gap-4">
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                    <div className="flex-1 w-full text-left">
                      <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">L∆∞u √Ω chung c·ªßa GV khi sinh nh·∫≠n x√©t</label>
                      <div className="relative">
                        <Sparkles size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400"/>
                        <input className="w-full bg-slate-50 border-2 border-slate-300 rounded-xl pl-12 pr-4 py-4 text-sm font-semibold outline-none" placeholder="VD: Nh·∫•n m·∫°nh t√≠nh t·ª± gi√°c, tinh th·∫ßn tr√°ch nhi·ªám..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)}/>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={runAI} disabled={isGenerating || students.length === 0} className="px-8 py-4 bg-indigo-600 text-white rounded-xl font-black text-xs hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2 uppercase shadow-lg">
                        {isGenerating ? <Loader2 className="animate-spin" size={18}/> : <Wand2 size={18}/>} Nh·∫≠n x√©t AI
                      </button>
                      <button onClick={() => { setEditItem(null); setBulkInput(''); setModalType('student'); }} className="p-4 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-black"><UserPlus size={20}/></button>
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center justify-between pt-2 border-t border-slate-100 gap-3">
                    <div className="flex gap-2">
                      <button onClick={() => setShowLevel(!showLevel)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showLevel ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showLevel ? <EyeOff size={14}/> : <Eye size={14}/>} {showLevel ? '·∫®n m·ª©c ƒë·∫°t' : 'Hi·ªán m·ª©c ƒë·∫°t'}
                      </button>
                      <button onClick={() => setShowNote(!showNote)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${showNote ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                        {showNote ? <EyeOff size={14}/> : <Eye size={14}/>} {showNote ? '·∫®n ghi ch√∫' : 'Hi·ªán ghi ch√∫'}
                      </button>
                    </div>
                    <button onClick={exportExcel} disabled={students.length === 0} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-black uppercase hover:bg-emerald-700 shadow-md transition-all disabled:opacity-50">
                      <Download size={14}/> T·∫£i Excel
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-2xl border-2 border-slate-400 shadow-2xl overflow-hidden mb-8">
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse min-w-[1200px]">
                      <thead>
                        <tr className="bg-slate-200 border-b-2 border-slate-400">
                          <th className="p-4 text-center text-[10px] font-black uppercase w-12 border-r border-slate-400 sticky left-0 bg-slate-200 z-10">STT</th>
                          <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400 sticky left-12 bg-slate-200 z-10">H·ªçc sinh</th>

                          {showLevel && GENERAL_COMPETENCIES.map(c => (viewMode === 'competency') ? <th key={c.id} className="p-4 text-center text-[9px] font-black uppercase border-r border-slate-400 w-24">{c.name}</th> : null)}
                          {showLevel && SPECIFIC_COMPETENCIES.map(c => (viewMode === 'specific') ? <th key={c.id} className="p-4 text-center text-[9px] font-black uppercase border-r border-slate-400 w-24">{c.name}</th> : null)}
                          {showLevel && QUALITIES.map(c => (viewMode === 'quality') ? <th key={c.id} className="p-4 text-center text-[9px] font-black uppercase border-r border-slate-400 w-24">{c.name}</th> : null)}

                          {showLevel && viewMode === 'subject' && (
                            <th className="p-4 text-center text-[10px] font-black uppercase w-32 border-r border-slate-400">M·ª©c ƒê·∫°t</th>
                          )}

                          {showNote && <th className="p-4 text-center text-[10px] font-black uppercase w-48 border-r border-slate-400">Ghi ch√∫</th>}
                          <th className="p-4 text-center text-[10px] font-black uppercase min-w-[400px]">Nh·∫≠n x√©t chi ti·∫øt</th>
                          <th className="p-4 w-24 text-center text-[10px] font-black uppercase">G·ª≠i</th>
                          <th className="p-4 w-10"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y-2 divide-slate-300">
                        {students.map((stu, idx) => (
                          <tr key={stu.id} className="hover:bg-indigo-50/50 transition-all">
                            <td className="p-3 text-center text-xs font-bold text-slate-400 border-r border-slate-400 sticky left-0 bg-slate-50">{idx + 1}</td>
                            <td className="p-3 border-r border-slate-400 text-left sticky left-12 bg-white z-0"><span className="font-black text-slate-800 text-sm uppercase">{stu.name}</span></td>
                            
                            {showLevel && renderLevelCells(stu)}

                            {showNote && <td className="p-3 border-r border-slate-400"><EditableCell value={studentData[stu.id]?.note} onSave={(val) => updateCell(stu.id, 'note', val)} className="w-full bg-transparent text-xs font-bold text-indigo-700 outline-none text-left" /></td>}
                            
                            <td className="p-3 text-left">
                              <EditableCell value={studentData[stu.id]?.comment} onSave={(val) => updateCell(stu.id, 'comment', val)} className="w-full bg-transparent text-sm font-medium border-none outline-none text-slate-700 text-left leading-relaxed" />
                            </td>
                            
                            <td className="p-3 text-center border-l border-slate-200">
                              <button disabled={!studentData[stu.id]?.comment} onClick={() => handleSendZalo(stu.id)} className={`p-2.5 rounded-full mx-auto shadow-sm transition-all ${copySuccess === stu.id ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white disabled:opacity-30'}`}>
                                {copySuccess === stu.id ? <CheckCircle2 size={18} /> : <ZaloIcon size={18} />}
                              </button>
                            </td>
                            <td className="p-3 text-center"><button onClick={() => setConfirmDelete({ type: 'student', id: stu.id, name: stu.name })} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ) : <div className="py-24 text-center bg-white rounded-3xl border-2 border-dashed border-slate-400 font-black text-slate-400 uppercase">Ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë√°nh gi√°</div>}
          </main>

          <footer className="max-w-7xl mx-auto w-full px-6 py-4 mt-8 bg-white/80 rounded-t-3xl border-t border-slate-200">
            <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                <div className="text-left italic">{AUTHOR_NAME} ‚Ä¢ {AUTHOR_PHONE}</div>
                <div className="text-right">H·ªá th·ªëng ƒê√°nh gi√° TH Kh√°nh B√¨nh ¬© {new Date().getFullYear()}</div>
            </div>
          </footer>

          {modalType && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
              <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-left">
                <h3 className="text-xl font-black uppercase text-slate-800 mb-6">{editItem ? "S·ª≠a" : "Th√™m m·ªõi"}</h3>
                {modalType === 'student' ? <textarea autoFocus className="w-full h-64 p-4 bg-slate-50 border-2 border-slate-300 rounded-xl mb-6 text-left font-bold outline-none" placeholder="D√°n danh s√°ch h·ªçc sinh (m·ªói t√™n m·ªôt d√≤ng)..." value={bulkInput} onChange={e => setBulkInput(e.target.value)}/> : <input autoFocus className="w-full p-4 bg-slate-50 border-2 border-slate-300 rounded-xl font-bold mb-6 text-left outline-none" value={inputValue} onChange={e => setInputValue(e.target.value)}/>}
                <div className="flex gap-4"><button onClick={() => setModalType(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={async () => {
                  if (modalType === 'student') {
                    if (!bulkInput.trim()) return;
                    const names = bulkInput.split('\n').map(n => n.trim()).filter(n => n !== '');
                    const col = colStudents(selectedYearId, selectedClassId);
                    for (const name of names) await col.add({ name, createdAt: Date.now() });
                    setBulkInput(''); setModalType(null);
                  } else {
                    if (!inputValue.trim()) return;
                    const colName = modalType === 'year' ? 'years' : modalType === 'class' ? 'classes' : modalType === 'month' ? 'months' : 'subjects';
                    if (editItem) await rootArtifacts().collection(colName).doc(editItem.id).update({ name: inputValue });
                    else await rootArtifacts().collection(colName).add({ name: inputValue, createdAt: Date.now() });
                    setInputValue(''); setModalType(null);
                  }
                }} className="flex-[2] py-4 bg-indigo-600 text-white font-black rounded-xl uppercase text-[10px]">L∆∞u</button></div>
              </div>
            </div>
          )}

          {confirmDelete && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
              <div className="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl">
                <div className="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldAlert size={32} /></div>
                <h3 className="text-lg font-black mb-2 uppercase">X√°c nh·∫≠n x√≥a</h3>
                <p className="text-slate-500 text-sm mb-6">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <span className="text-red-600 font-bold">"{confirmDelete.name}"</span> kh√¥ng?</p>
                <div className="flex gap-4"><button onClick={() => setConfirmDelete(null)} className="flex-1 py-4 font-black text-slate-400 uppercase text-[10px]">H·ªßy</button><button onClick={async () => {
                  if (confirmDelete.type === 'student') await colStudents(selectedYearId, selectedClassId).doc(confirmDelete.id).delete();
                  else await rootArtifacts().collection(confirmDelete.type === 'year' ? 'years' : confirmDelete.type === 'class' ? 'classes' : confirmDelete.type === 'month' ? 'months' : 'subjects').doc(confirmDelete.id).delete();
                  setConfirmDelete(null);
                }} className="flex-1 py-4 bg-red-600 text-white font-black rounded-xl uppercase text-[10px]">X√≥a</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>